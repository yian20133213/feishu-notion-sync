<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È£û‰π¶-NotionÂêåÊ≠•ÁÆ°ÁêÜÁ≥ªÁªü</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        .main-content {
            padding: 30px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-card h3 {
            color: #2d3748;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        .stat-card .label {
            color: #718096;
            font-size: 14px;
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #2d3748;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        .btn-success {
            background: #48bb78;
        }
        .btn-success:hover {
            background: #38a169;
        }
        .btn-danger {
            background: #f56565;
        }
        .btn-danger:hover {
            background: #e53e3e;
        }
        .btn-secondary {
            background: #718096;
        }
        .btn-secondary:hover {
            background: #4a5568;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th,
        .table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .status-success {
            background: #c6f6d5;
            color: #22543d;
        }
        .status-warning {
            background: #faf089;
            color: #744210;
        }
        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }
        .status-info {
            background: #bee3f8;
            color: #2a4365;
        }
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        .alert-info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }
        .hidden {
            display: none;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: none;
            border: none;
            color: #718096;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .tab.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .config-item {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .config-actions {
            margin-top: 15px;
        }
        .config-actions button {
            margin-right: 10px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }
        .empty-state h3 {
            margin-bottom: 10px;
            color: #4a5568;
        }
        
        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>üîÑ È£û‰π¶-NotionÂêåÊ≠•ÁÆ°ÁêÜÁ≥ªÁªü</h1>
            <p>ÂÆûÊó∂ÂêåÊ≠• | Êô∫ËÉΩÁÆ°ÁêÜ | È´òÊïàÂçè‰Ωú</p>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <!-- ÁªüËÆ°Èù¢Êùø -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ÊÄªÂêåÊ≠•Ê¨°Êï∞</h3>
                    <div class="value" id="totalSyncs">0</div>
                    <div class="label">Ê¨°ÂêåÊ≠•Êìç‰Ωú</div>
                </div>
                <div class="stat-card">
                    <h3>ÊàêÂäüÁéá</h3>
                    <div class="value" id="successRate">0%</div>
                    <div class="label">ÂêåÊ≠•ÊàêÂäüÁéá</div>
                </div>
                <div class="stat-card">
                    <h3>ÂæÖÂ§ÑÁêÜ‰ªªÂä°</h3>
                    <div class="value" id="pendingTasks">0</div>
                    <div class="label">‰∏™Á≠âÂæÖÂêåÊ≠•</div>
                </div>
                <div class="stat-card">
                    <h3>ÂêØÁî®ÈÖçÁΩÆ</h3>
                    <div class="value" id="enabledConfigs">0</div>
                    <div class="label">‰∏™ÊñáÊ°£ÈÖçÁΩÆ</div>
                </div>
            </div>

            <!-- Á≥ªÁªüÁä∂ÊÄÅ -->
            <div class="section">
                <h2>üîç Á≥ªÁªüÁä∂ÊÄÅ</h2>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div>
                        <strong>Êï∞ÊçÆÂ∫ì:</strong>
                        <span class="status-badge status-success" id="dbStatus">ËøûÊé•Ê≠£Â∏∏</span>
                    </div>
                    <div>
                        <strong>È£û‰π¶API:</strong>
                        <span class="status-badge status-success" id="feishuStatus">ËøûÊé•Ê≠£Â∏∏</span>
                    </div>
                    <div>
                        <strong>Notion API:</strong>
                        <span class="status-badge status-success" id="notionStatus">ÈÖçÁΩÆÊ≠£Â∏∏</span>
                    </div>
                    <div>
                        <strong>‰∏ÉÁâõ‰∫ë:</strong>
                        <span class="status-badge status-success" id="qiniuStatus">ÈÖçÁΩÆÊ≠£Â∏∏</span>
                    </div>
                </div>
            </div>

            <!-- ÂäüËÉΩÊ†áÁ≠æÈ°µ -->
            <div class="section">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('configs')">üìã ÂêåÊ≠•ÈÖçÁΩÆ</button>
                    <button class="tab" onclick="showTab('trigger')">üöÄ ÊâãÂä®ÂêåÊ≠•</button>
                    <button class="tab" onclick="showTab('history')">üìä ÂêåÊ≠•ÂéÜÂè≤</button>
                    <button class="tab" onclick="showTab('images')">üñºÔ∏è ÂõæÁâáÁÆ°ÁêÜ</button>
                </div>

                <!-- ÂêåÊ≠•ÈÖçÁΩÆÊ†áÁ≠æÈ°µ -->
                <div id="configs" class="tab-content active">
                    <h2>üìã ÂêåÊ≠•ÈÖçÁΩÆÁÆ°ÁêÜ</h2>
                    
                    <!-- Ê∑ªÂä†Êñ∞ÈÖçÁΩÆ -->
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px; color: #4a5568;">‚ûï Ê∑ªÂä†Êñ∞ÁöÑÂêåÊ≠•ÈÖçÁΩÆ</h3>
                        <form id="addConfigForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="platform">Âπ≥Âè∞</label>
                                    <select id="platform" class="form-control" required>
                                        <option value="">ÈÄâÊã©Âπ≥Âè∞</option>
                                        <option value="feishu">È£û‰π¶ (Feishu)</option>
                                        <option value="notion">Notion</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="documentId">ÊñáÊ°£/È°µÈù¢ID</label>
                                    <input type="text" id="documentId" class="form-control" 
                                           placeholder="ËæìÂÖ•ÊñáÊ°£IDÊàñÈ°µÈù¢ID" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="syncDirection">ÂêåÊ≠•ÊñπÂêë</label>
                                    <select id="syncDirection" class="form-control" required>
                                        <option value="">ÈÄâÊã©ÂêåÊ≠•ÊñπÂêë</option>
                                        <option value="feishu_to_notion">È£û‰π¶ ‚Üí Notion</option>
                                        <option value="notion_to_feishu">Notion ‚Üí È£û‰π¶</option>
                                        <option value="bidirectional">ÂèåÂêëÂêåÊ≠•</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="autoSync" checked>
                                        ÂêØÁî®Ëá™Âä®ÂêåÊ≠•
                                    </label>
                                    <br>
                                    <label>
                                        <input type="checkbox" id="isEnabled" checked>
                                        ÂêØÁî®Ê≠§ÈÖçÁΩÆ
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                ‚ûï Ê∑ªÂä†ÈÖçÁΩÆ
                            </button>
                        </form>
                    </div>

                    <!-- Áé∞ÊúâÈÖçÁΩÆÂàóË°® -->
                    <div id="configsList">
                        <h3 style="margin-bottom: 20px; color: #4a5568;">üìã Áé∞ÊúâÂêåÊ≠•ÈÖçÁΩÆ</h3>
                        <div id="configsContainer">
                            <!-- ÈÖçÁΩÆÈ°πÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                        </div>
                    </div>
                </div>

                <!-- ÊâãÂä®ÂêåÊ≠•Ê†áÁ≠æÈ°µ -->
                <div id="trigger" class="tab-content">
                    <h2>üöÄ ÊâãÂä®Ëß¶ÂèëÂêåÊ≠•</h2>
                    
                    <div style="background: #fef5e7; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #f6ad55;">
                        <h3 style="color: #c05621; margin-bottom: 10px;">‚ö†Ô∏è ‰ΩøÁî®ËØ¥Êòé</h3>
                        <ul style="color: #9c4221; margin-left: 20px;">
                            <li>ÊâãÂä®ÂêåÊ≠•ÈÄÇÁî®‰∫éÈúÄË¶ÅÁ´ãÂç≥ÂêåÊ≠•ÁöÑÂú∫ÊôØ</li>
                            <li>È£û‰π¶‚ÜíNotionÔºöÂª∫ËÆÆÁî®‰∫éÂÜÖÂÆπÂèëÂ∏É</li>
                            <li>Notion‚ÜíÈ£û‰π¶ÔºöÈúÄË¶ÅË∞®ÊÖéÊìç‰ΩúÔºåÈÅøÂÖçË¶ÜÁõñÈáçË¶ÅÂÜÖÂÆπ</li>
                            <li>Á°Æ‰øùÊñáÊ°£IDÊ≠£Á°ÆÔºåÈÅøÂÖçÂêåÊ≠•Âà∞ÈîôËØØÁõÆÊ†á</li>
                        </ul>
                    </div>

                    <form id="triggerSyncForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="triggerSourcePlatform">Ê∫êÂπ≥Âè∞</label>
                                <select id="triggerSourcePlatform" class="form-control" required>
                                    <option value="">ÈÄâÊã©Ê∫êÂπ≥Âè∞</option>
                                    <option value="feishu" selected>È£û‰π¶ (Feishu)</option>
                                    <option value="notion">Notion</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="triggerTargetPlatform">ÁõÆÊ†áÂπ≥Âè∞</label>
                                <select id="triggerTargetPlatform" class="form-control" required>
                                    <option value="">ÈÄâÊã©ÁõÆÊ†áÂπ≥Âè∞</option>
                                    <option value="feishu">È£û‰π¶ (Feishu)</option>
                                    <option value="notion" selected>Notion</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="triggerSourceId">Ê∫êÊñáÊ°£ID</label>
                                <input type="text" id="triggerSourceId" class="form-control" 
                                       placeholder="ËæìÂÖ•Ë¶ÅÂêåÊ≠•ÁöÑÊñáÊ°£ID" required>
                            </div>
                            <div class="form-group">
                                <label for="triggerContentType">ÂÜÖÂÆπÁ±ªÂûã</label>
                                <select id="triggerContentType" class="form-control" required>
                                    <option value="document" selected>ÊñáÊ°£ (Document)</option>
                                    <option value="database">Êï∞ÊçÆÂ∫ì/Ë°®Ê†º (Database)</option>
                                    <option value="page">È°µÈù¢ (Page)</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">
                            üöÄ Á´ãÂç≥ÂêåÊ≠•
                        </button>
                    </form>

                    <!-- ÂêåÊ≠•ÁªìÊûúÊòæÁ§∫ -->
                    <div id="syncResult" class="hidden" style="margin-top: 30px;">
                        <!-- ÁªìÊûúÂ∞ÜÈÄöËøáJavaScriptÊòæÁ§∫ -->
                    </div>
                </div>

                <!-- ÂêåÊ≠•ÂéÜÂè≤Ê†áÁ≠æÈ°µ -->
                <div id="history" class="tab-content">
                    <h2>üìä ÂêåÊ≠•ÂéÜÂè≤ËÆ∞ÂΩï</h2>
                    
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button class="btn btn-secondary" onclick="refreshHistory()">
                            üîÑ Âà∑Êñ∞ÂéÜÂè≤
                        </button>
                        <button class="btn btn-secondary" onclick="showPendingTasks()">
                            ‚è≥ ÂæÖÂ§ÑÁêÜ‰ªªÂä°
                        </button>
                        <button class="btn btn-secondary" onclick="showFailedTasks()">
                            ‚ùå Â§±Ë¥•‰ªªÂä°
                        </button>
                        <div style="margin-left: auto; display: flex; gap: 10px;">
                            <button class="btn btn-danger" onclick="showDeleteMenu()">
                                üóëÔ∏è Âà†Èô§ËÆ∞ÂΩï
                            </button>
                        </div>
                    </div>

                    <!-- Âà†Èô§ËèúÂçï -->
                    <div id="deleteMenu" class="hidden" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
                        <h4 style="color: #dc3545; margin-bottom: 15px;">üóëÔ∏è Âà†Èô§ÂéÜÂè≤ËÆ∞ÂΩï</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                            <button class="btn btn-danger" onclick="clearRecords('success')">
                                Âà†Èô§ÊàêÂäüËÆ∞ÂΩï
                            </button>
                            <button class="btn btn-danger" onclick="clearRecords('failed')">
                                Âà†Èô§Â§±Ë¥•ËÆ∞ÂΩï
                            </button>
                            <button class="btn btn-danger" onclick="clearRecords('pending')">
                                Âà†Èô§ÂæÖÂ§ÑÁêÜËÆ∞ÂΩï
                            </button>
                            <button class="btn btn-danger" onclick="clearRecords('all')">
                                Âà†Èô§ÂÖ®ÈÉ®ËÆ∞ÂΩï
                            </button>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="hideDeleteMenu()">
                                ÂèñÊ∂à
                            </button>
                            <label style="margin-left: auto; color: #6c757d; font-size: 14px;">
                                <input type="checkbox" id="enableBatchDelete" onchange="toggleBatchSelect()"> ÊâπÈáèÈÄâÊã©Âà†Èô§
                            </label>
                        </div>
                    </div>

                    <div id="historyContainer">
                        <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                    </div>
                </div>

                <!-- ÂõæÁâáÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
                <div id="images" class="tab-content">
                    <h2>üñºÔ∏è ÂõæÁâáÂ≠òÂÇ®ÁÆ°ÁêÜ</h2>
                    
                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <h3>ÂõæÁâáÊÄªÊï∞</h3>
                            <div class="value" id="totalImages">0</div>
                            <div class="label">Âº†ÂõæÁâá</div>
                        </div>
                        <div class="stat-card">
                            <h3>Â≠òÂÇ®‰ΩøÁî®</h3>
                            <div class="value" id="storageUsage">0 MB</div>
                            <div class="label">Â≠òÂÇ®Á©∫Èó¥</div>
                        </div>
                        <div class="stat-card">
                            <h3>ËÆøÈóÆÊ¨°Êï∞</h3>
                            <div class="value" id="totalAccess">0</div>
                            <div class="label">Ê¨°ËÆøÈóÆ</div>
                        </div>
                        <div class="stat-card">
                            <h3>Âπ≥ÂùáÂ§ßÂ∞è</h3>
                            <div class="value" id="avgSize">0 KB</div>
                            <div class="label">ÂçïÂº†Âπ≥Âùá</div>
                        </div>
                    </div>

                    <div style="background: #e6f7ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #1890ff;">
                        <h3 style="color: #003a8c; margin-bottom: 10px;">üí° ÂõæÁâáÂ§ÑÁêÜËØ¥Êòé</h3>
                        <ul style="color: #0050b3; margin-left: 20px;">
                            <li>Á≥ªÁªüËá™Âä®Â∞ÜÂõæÁâáÂéãÁº©‰∏∫WebPÊ†ºÂºèÔºåÂèØÂáèÂ∞ë70%ÁöÑÂ≠òÂÇ®Á©∫Èó¥</li>
                            <li>‰ΩøÁî®MD5Ê†°È™åÂÆûÁé∞ÂéªÈáçÔºåÁõ∏ÂêåÂõæÁâáÂè™Â≠òÂÇ®‰∏Ä‰ªΩ</li>
                            <li>ÂõæÁâá‰∏ä‰º†Âà∞‰∏ÉÁâõ‰∫ëCDNÔºåÊèê‰æõÂø´ÈÄüËÆøÈóÆ</li>
                            <li>ÂÖçË¥πÈ¢ùÂ∫¶Ôºö10GBÂ≠òÂÇ® + 10GB CDNÊµÅÈáè/Êúà</li>
                        </ul>
                    </div>

                    <div id="imagesContainer">
                        <!-- ÂõæÁâáÁªüËÆ°ÂíåÁÆ°ÁêÜÁïåÈù¢ -->
                        <div class="empty-state">
                            <h3>ÊöÇÊó†ÂõæÁâáÊï∞ÊçÆ</h3>
                            <p>ÂΩìÊúâÂõæÁâá‰∏ä‰º†Êó∂ÔºåÁõ∏ÂÖ≥ÁªüËÆ°‰ø°ÊÅØÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ÂÖ®Â±ÄÁä∂ÊÄÅ
        let dashboardData = {};
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            loadConfigs();
            
            // ËÆæÁΩÆË°®ÂçïÊèê‰∫§‰∫ã‰ª∂
            document.getElementById('addConfigForm').addEventListener('submit', handleAddConfig);
            document.getElementById('triggerSyncForm').addEventListener('submit', handleTriggerSync);
        });

        // ÊòæÁ§∫Ê†áÁ≠æÈ°µ
        function showTab(tabName) {
            // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÈ°µÂÜÖÂÆπ
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÁöÑactiveÁ±ª
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÈ°µ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Ê†πÊçÆÊ†áÁ≠æÈ°µÂä†ËΩΩÁõ∏Â∫îÊï∞ÊçÆ
            switch(tabName) {
                case 'configs':
                    loadConfigs();
                    break;
                case 'history':
                    loadHistory();
                    break;
                case 'images':
                    loadImageStats();
                    break;
            }
        }

        // Âä†ËΩΩ‰ª™Ë°®ÊùøÊï∞ÊçÆ
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard');
                dashboardData = await response.json();
                
                updateStats();
                updateSystemStatus();
            } catch (error) {
                console.error('Âä†ËΩΩ‰ª™Ë°®ÊùøÊï∞ÊçÆÂ§±Ë¥•:', error);
                showAlert('error', 'Êó†Ê≥ïÂä†ËΩΩÁ≥ªÁªüÊï∞ÊçÆÔºåËØ∑Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ');
            }
        }

        // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
        function updateStats() {
            const summary = dashboardData.summary || {};
            
            document.getElementById('totalSyncs').textContent = summary.total_syncs || 0;
            document.getElementById('successRate').textContent = (summary.success_rate || 0) + '%';
            document.getElementById('pendingTasks').textContent = summary.pending_tasks || 0;
            document.getElementById('enabledConfigs').textContent = summary.enabled_configs || 0;
        }

        // Êõ¥Êñ∞Á≥ªÁªüÁä∂ÊÄÅ
        function updateSystemStatus() {
            const status = dashboardData.system_status || {};
            
            updateStatusBadge('dbStatus', status.database);
            updateStatusBadge('feishuStatus', status.feishu_api);
            updateStatusBadge('notionStatus', status.notion_api);
            updateStatusBadge('qiniuStatus', status.qiniu_storage);
        }

        // Êõ¥Êñ∞Áä∂ÊÄÅÊ†áËØÜ
        function updateStatusBadge(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = 'status-badge';
            
            if (status === 'connected' || status === 'configured') {
                element.classList.add('status-success');
                element.textContent = 'ËøûÊé•Ê≠£Â∏∏';
            } else if (status === 'error') {
                element.classList.add('status-error');
                element.textContent = 'ËøûÊé•Â§±Ë¥•';
            } else {
                element.classList.add('status-warning');
                element.textContent = 'Áä∂ÊÄÅÊú™Áü•';
            }
        }

        // Âä†ËΩΩÈÖçÁΩÆÂàóË°®
        async function loadConfigs() {
            try {
                const response = await fetch('/api/sync/configs');
                const data = await response.json();
                
                displayConfigs(data.data || []);
            } catch (error) {
                console.error('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•:', error);
                showAlert('error', 'Êó†Ê≥ïÂä†ËΩΩÂêåÊ≠•ÈÖçÁΩÆ');
            }
        }

        // ÊòæÁ§∫ÈÖçÁΩÆÂàóË°®
        function displayConfigs(configs) {
            const container = document.getElementById('configsContainer');
            
            if (configs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ÊöÇÊó†ÂêåÊ≠•ÈÖçÁΩÆ</h3>
                        <p>ËØ∑Âú®‰∏äÊñπÊ∑ªÂä†Êñ∞ÁöÑÂêåÊ≠•ÈÖçÁΩÆ</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = configs.map(config => `
                <div class="config-item">
                    <div style="display: flex; justify-content: between; align-items: center;">
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 10px; color: #2d3748;">
                                ${config.platform === 'feishu' ? 'üì± È£û‰π¶' : 'üìã Notion'} ÊñáÊ°£ÈÖçÁΩÆ
                            </h4>
                            <p><strong>ÊñáÊ°£ID:</strong> ${config.document_id}</p>
                            <p><strong>ÂêåÊ≠•ÊñπÂêë:</strong> ${getSyncDirectionText(config.sync_direction)}</p>
                            <p><strong>Áä∂ÊÄÅ:</strong> 
                                <span class="status-badge ${config.is_sync_enabled ? 'status-success' : 'status-error'}">
                                    ${config.is_sync_enabled ? 'Â∑≤ÂêØÁî®' : 'Â∑≤Á¶ÅÁî®'}
                                </span>
                                ${config.auto_sync ? '<span class="status-badge status-info">Ëá™Âä®ÂêåÊ≠•</span>' : '<span class="status-badge status-warning">ÊâãÂä®ÂêåÊ≠•</span>'}
                            </p>
                        </div>
                    </div>
                    <div class="config-actions">
                        <button class="btn ${config.is_sync_enabled ? 'btn-danger' : 'btn-success'}" 
                                onclick="toggleConfig(${config.id}, ${!config.is_sync_enabled})">
                            ${config.is_sync_enabled ? 'üî• Á¶ÅÁî®' : '‚úÖ ÂêØÁî®'}
                        </button>
                        <button class="btn btn-secondary" onclick="editConfig(${config.id})">
                            ‚úèÔ∏è ÁºñËæë
                        </button>
                        <button class="btn btn-danger" onclick="deleteConfig(${config.id})">
                            üóëÔ∏è Âà†Èô§
                        </button>
                        <button class="btn" onclick="testSync('${config.platform}', '${config.document_id}')">
                            üß™ ÊµãËØïÂêåÊ≠•
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Ëé∑ÂèñÂêåÊ≠•ÊñπÂêëÊñáÊú¨
        function getSyncDirectionText(direction) {
            const directions = {
                'feishu_to_notion': 'È£û‰π¶ ‚Üí Notion',
                'notion_to_feishu': 'Notion ‚Üí È£û‰π¶',
                'bidirectional': 'ÂèåÂêëÂêåÊ≠•'
            };
            return directions[direction] || direction;
        }

        // Â§ÑÁêÜÊ∑ªÂä†ÈÖçÁΩÆ
        async function handleAddConfig(event) {
            event.preventDefault();
            
            const formData = {
                platform: document.getElementById('platform').value,
                document_id: document.getElementById('documentId').value,
                sync_direction: document.getElementById('syncDirection').value,
                is_sync_enabled: document.getElementById('isEnabled').checked,
                auto_sync: document.getElementById('autoSync').checked
            };

            try {
                const response = await fetch('/api/sync/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', 'ÂêåÊ≠•ÈÖçÁΩÆÊ∑ªÂä†ÊàêÂäüÔºÅ');
                    document.getElementById('addConfigForm').reset();
                    loadConfigs();
                    loadDashboardData();
                } else {
                    showAlert('error', result.error || 'Ê∑ªÂä†ÈÖçÁΩÆÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Ê∑ªÂä†ÈÖçÁΩÆÂ§±Ë¥•:', error);
                showAlert('error', 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // Â§ÑÁêÜËß¶ÂèëÂêåÊ≠•
        let syncInProgress = false;  // Èò≤ÈáçÂ§çÊèê‰∫§Ê†áÂøó
        
        async function handleTriggerSync(event) {
            event.preventDefault();
            
            // Èò≤ÈáçÂ§çÊèê‰∫§Ê£ÄÊü•
            if (syncInProgress) {
                showSyncResult('warning', 'ÂêåÊ≠•Ê≠£Âú®ËøõË°å‰∏≠ÔºåËØ∑ÂãøÈáçÂ§çÊèê‰∫§');
                return;
            }
            
            const submitButton = document.querySelector('#triggerSyncForm button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            try {
                // ËÆæÁΩÆÊèê‰∫§Áä∂ÊÄÅ
                syncInProgress = true;
                submitButton.disabled = true;
                submitButton.innerHTML = 'üîÑ ÂêåÊ≠•‰∏≠...';
                
                const formData = {
                    source_platform: document.getElementById('triggerSourcePlatform').value,
                    target_platform: document.getElementById('triggerTargetPlatform').value,
                    source_id: document.getElementById('triggerSourceId').value,
                    content_type: document.getElementById('triggerContentType').value
                };

                const response = await fetch('/api/sync/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showSyncResult('success', 'ÂêåÊ≠•‰ªªÂä°Â∑≤ÂàõÂª∫', result);
                    loadDashboardData();
                    // Ê∏ÖÁ©∫Ë°®ÂçïÊ∫êÊñáÊ°£IDÂ≠óÊÆµ
                    document.getElementById('triggerSourceId').value = '';
                } else {
                    showSyncResult('error', result.error || 'ÂêåÊ≠•Â§±Ë¥•', result);
                }
            } catch (error) {
                console.error('Ëß¶ÂèëÂêåÊ≠•Â§±Ë¥•:', error);
                showSyncResult('error', 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            } finally {
                // ÊÅ¢Â§çÊèê‰∫§Áä∂ÊÄÅ
                syncInProgress = false;
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        }

        // ÊòæÁ§∫ÂêåÊ≠•ÁªìÊûú
        function showSyncResult(type, message, result = {}) {
            const container = document.getElementById('syncResult');
            
            // Â§ÑÁêÜ‰∏çÂêåÁ±ªÂûãÁöÑÊ†∑Âºè
            let alertClass, icon, title;
            switch(type) {
                case 'success':
                    alertClass = 'alert-success';
                    icon = '‚úÖ';
                    title = 'ÂêåÊ≠•ÊàêÂäü';
                    break;
                case 'warning':
                    alertClass = 'alert-warning';
                    icon = '‚ö†Ô∏è';
                    title = 'Ê≥®ÊÑè';
                    break;
                case 'error':
                default:
                    alertClass = 'alert-danger';
                    icon = '‚ùå';
                    title = 'ÂêåÊ≠•Â§±Ë¥•';
            }
            
            container.className = `alert ${alertClass}`;
            container.innerHTML = `
                <h4>${icon} ${title}</h4>
                <p>${message}</p>
                ${result.sync_record_id ? `<p><strong>ÂêåÊ≠•ËÆ∞ÂΩïID:</strong> ${result.sync_record_id}</p>` : ''}
                ${result.timestamp ? `<p><strong>Êó∂Èó¥:</strong> ${new Date(result.timestamp).toLocaleString()}</p>` : ''}
            `;
            container.classList.remove('hidden');
            
            // Ë≠¶ÂëäÊ∂àÊÅØ3ÁßíÂêéËá™Âä®ÈöêËóè
            if (type === 'warning') {
                setTimeout(() => {
                    container.classList.add('hidden');
                }, 3000);
            }
        }


        // ÂàáÊç¢ÈÖçÁΩÆÂêØÁî®Áä∂ÊÄÅ
        async function toggleConfig(configId, enabled) {
            try {
                const response = await fetch(`/api/sync/config/${configId}/toggle`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('success', data.message);
                    loadConfigs(); // Á´ãÂç≥Âà∑Êñ∞ÈÖçÁΩÆÂàóË°®
                    loadDashboardData(); // Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆ
                } else {
                    showAlert('error', data.message || 'Êìç‰ΩúÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÂàáÊç¢ÈÖçÁΩÆÁä∂ÊÄÅÂ§±Ë¥•:', error);
                showAlert('error', 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ÁºñËæëÈÖçÁΩÆ
        async function editConfig(configId) {
            try {
                const response = await fetch(`/api/sync/config/${configId}`);
                const data = await response.json();
                
                if (data.success) {
                    const config = data.data;
                    showEditModal(config);
                } else {
                    showAlert('error', data.message || 'Êó†Ê≥ïÂä†ËΩΩÈÖçÁΩÆ‰ø°ÊÅØ');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÈÖçÁΩÆ‰ø°ÊÅØÂ§±Ë¥•:', error);
                showAlert('error', 'Êó†Ê≥ïÂä†ËΩΩÈÖçÁΩÆ‰ø°ÊÅØ');
            }
        }

        // ÊòæÁ§∫ÁºñËæëÊ®°ÊÄÅÊ°Ü
        function showEditModal(config) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>ÁºñËæëÂêåÊ≠•ÈÖçÁΩÆ</h3>
                    <form id="editConfigForm">
                        <div class="form-group">
                            <label for="editPlatform">Âπ≥Âè∞</label>
                            <select id="editPlatform" class="form-control" required>
                                <option value="feishu" ${config.platform === 'feishu' ? 'selected' : ''}>È£û‰π¶ (Feishu)</option>
                                <option value="notion" ${config.platform === 'notion' ? 'selected' : ''}>Notion</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editDocumentId">ÊñáÊ°£ID</label>
                            <input type="text" id="editDocumentId" class="form-control" 
                                   value="${config.document_id}" required>
                        </div>
                        <div class="form-group">
                            <label for="editSyncDirection">ÂêåÊ≠•ÊñπÂêë</label>
                            <select id="editSyncDirection" class="form-control" required>
                                <option value="feishu_to_notion" ${config.sync_direction === 'feishu_to_notion' ? 'selected' : ''}>È£û‰π¶ ‚Üí Notion</option>
                                <option value="notion_to_feishu" ${config.sync_direction === 'notion_to_feishu' ? 'selected' : ''}>Notion ‚Üí È£û‰π¶</option>
                                <option value="bidirectional" ${config.sync_direction === 'bidirectional' ? 'selected' : ''}>ÂèåÂêëÂêåÊ≠•</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editIsEnabled" ${config.is_sync_enabled ? 'checked' : ''}> ÂêØÁî®ÂêåÊ≠•
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editAutoSync" ${config.auto_sync ? 'checked' : ''}> Ëá™Âä®ÂêåÊ≠•
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">ÂèñÊ∂à</button>
                            <button type="submit" class="btn btn-success">‰øùÂ≠ò</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Â§ÑÁêÜË°®ÂçïÊèê‰∫§
            document.getElementById('editConfigForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveEditConfig(config.id);
            });
        }

        // ‰øùÂ≠òÁºñËæëÁöÑÈÖçÁΩÆ
        async function saveEditConfig(configId) {
            try {
                const formData = {
                    platform: document.getElementById('editPlatform').value,
                    document_id: document.getElementById('editDocumentId').value,
                    sync_direction: document.getElementById('editSyncDirection').value,
                    is_sync_enabled: document.getElementById('editIsEnabled').checked,
                    auto_sync: document.getElementById('editAutoSync').checked
                };

                const response = await fetch(`/api/sync/config/${configId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('success', 'ÈÖçÁΩÆÊõ¥Êñ∞ÊàêÂäü');
                    closeEditModal();
                    loadConfigs(); // Á´ãÂç≥Âà∑Êñ∞ÈÖçÁΩÆÂàóË°®
                    loadDashboardData(); // Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆ
                } else {
                    showAlert('error', data.message || 'Êõ¥Êñ∞Â§±Ë¥•');
                }
            } catch (error) {
                console.error('‰øùÂ≠òÈÖçÁΩÆÂ§±Ë¥•:', error);
                showAlert('error', 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ÂÖ≥Èó≠ÁºñËæëÊ®°ÊÄÅÊ°Ü
        function closeEditModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // Âà†Èô§ÈÖçÁΩÆ
        async function deleteConfig(configId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÈÖçÁΩÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
                return;
            }

            try {
                const response = await fetch(`/api/sync/config/${configId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('success', 'ÈÖçÁΩÆÂ∑≤Âà†Èô§');
                    loadConfigs();
                    loadDashboardData();
                } else {
                    const result = await response.json();
                    showAlert('error', result.error || 'Âà†Èô§Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Âà†Èô§ÈÖçÁΩÆÂ§±Ë¥•:', error);
                showAlert('error', 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // Âä†ËΩΩÂêåÊ≠•ÂéÜÂè≤
        async function loadHistory() {
            try {
                const response = await fetch('/api/sync/history');
                const data = await response.json();
                
                displayHistory(data.data.history || []);
            } catch (error) {
                console.error('Âä†ËΩΩÂéÜÂè≤Â§±Ë¥•:', error);
                showAlert('error', 'Êó†Ê≥ïÂä†ËΩΩÂêåÊ≠•ÂéÜÂè≤');
            }
        }

        // ÊòæÁ§∫ÂêåÊ≠•ÂéÜÂè≤
        function displayHistory(history) {
            const container = document.getElementById('historyContainer');
            const isBatchMode = document.getElementById('enableBatchDelete')?.checked || false;
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ÊöÇÊó†ÂêåÊ≠•ËÆ∞ÂΩï</h3>
                        <p>ÂΩìÊúâÂêåÊ≠•Êìç‰ΩúÊó∂ÔºåËÆ∞ÂΩïÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                ${isBatchMode ? `
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label>
                                <input type="checkbox" id="selectAllRecords" onchange="toggleSelectAll()"> ÂÖ®ÈÄâ
                            </label>
                            <button class="btn btn-danger" onclick="deleteBatchRecords()" style="font-size: 14px;">
                                üóëÔ∏è Âà†Èô§ÈÄâ‰∏≠ËÆ∞ÂΩï
                            </button>
                        </div>
                    </div>
                ` : ''}
                <table class="table">
                    <thead>
                        <tr>
                            ${isBatchMode ? '<th width="50px">ÈÄâÊã©</th>' : ''}
                            <th>ÁºñÂè∑</th>
                            <th>Êó∂Èó¥</th>
                            <th>Êù•Ê∫ê</th>
                            <th>ÁõÆÊ†á</th>
                            <th>ÊñáÊ°£ID</th>
                            <th>Á±ªÂûã</th>
                            <th>Áä∂ÊÄÅ</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.map(record => `
                            <tr>
                                ${isBatchMode ? `<td><input type="checkbox" class="record-checkbox" value="${record.id}"></td>` : ''}
                                <td>
                                    <span style="font-family: monospace; font-size: 12px; background: #e2e8f0; padding: 2px 6px; border-radius: 4px;">
                                        ${record.record_number || `SYNC-${String(record.id).padStart(6, '0')}`}
                                    </span>
                                </td>
                                <td>${new Date(record.created_at).toLocaleString()}</td>
                                <td>${record.source_platform === 'feishu' ? 'üì± È£û‰π¶' : 'üìã Notion'}</td>
                                <td>${record.target_platform === 'feishu' ? 'üì± È£û‰π¶' : 'üìã Notion'}</td>
                                <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${record.source_id}">${record.source_id}</td>
                                <td>${record.content_type}</td>
                                <td>
                                    <span class="status-badge ${getStatusClass(record.sync_status)}">
                                        ${getStatusText(record.sync_status)}
                                    </span>
                                </td>
                                <td style="white-space: nowrap;">
                                    <button class="btn btn-secondary" onclick="retrySync(${record.id})" 
                                            style="font-size: 12px; padding: 5px 10px; margin-right: 5px;">
                                        üîÑ ÈáçËØï
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteRecord(${record.id})" 
                                            style="font-size: 12px; padding: 5px 10px;">
                                        üóëÔ∏è Âà†Èô§
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Ëé∑ÂèñÁä∂ÊÄÅÊ†∑ÂºèÁ±ª
        function getStatusClass(status) {
            const classes = {
                'success': 'status-success',
                'failed': 'status-error',
                'pending': 'status-warning',
                'processing': 'status-info'
            };
            return classes[status] || 'status-warning';
        }

        // Ëé∑ÂèñÁä∂ÊÄÅÊñáÊú¨
        function getStatusText(status) {
            const texts = {
                'success': 'ÊàêÂäü',
                'failed': 'Â§±Ë¥•',
                'pending': 'Á≠âÂæÖ‰∏≠',
                'processing': 'Â§ÑÁêÜ‰∏≠'
            };
            return texts[status] || status;
        }

        // Âä†ËΩΩÂõæÁâáÁªüËÆ°
        async function loadImageStats() {
            const imageStats = dashboardData.image_stats || {};
            
            document.getElementById('totalImages').textContent = imageStats.total_images || 0;
            document.getElementById('storageUsage').textContent = (imageStats.size_mb || 0) + ' MB';
            document.getElementById('totalAccess').textContent = imageStats.total_access || 0;
            document.getElementById('avgSize').textContent = Math.round((imageStats.avg_size || 0) / 1024) + ' KB';
        }

        // ÊòæÁ§∫ÈÄöÁü•
        function showAlert(type, message) {
            // ÂàõÂª∫‰∏¥Êó∂ÈÄöÁü•ÂÖÉÁ¥†
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.minWidth = '300px';
            alert.innerHTML = `
                <strong>${type === 'success' ? '‚úÖ ÊàêÂäü' : '‚ùå ÈîôËØØ'}</strong><br>
                ${message}
            `;
            
            document.body.appendChild(alert);
            
            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                document.body.removeChild(alert);
            }, 3000);
        }

        // Âà∑Êñ∞ÂéÜÂè≤
        function refreshHistory() {
            loadHistory();
            showAlert('success', 'ÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤Âà∑Êñ∞');
        }

        // ÊòæÁ§∫ÂæÖÂ§ÑÁêÜ‰ªªÂä°
        async function showPendingTasks() {
            try {
                const response = await fetch('/api/sync/pending');
                const data = await response.json();
                displayHistory(data.data.records || []);
            } catch (error) {
                showAlert('error', 'Êó†Ê≥ïÂä†ËΩΩÂæÖÂ§ÑÁêÜ‰ªªÂä°');
            }
        }

        // ÊòæÁ§∫Â§±Ë¥•‰ªªÂä°
        async function showFailedTasks() {
            try {
                const response = await fetch('/api/sync/failed');
                const data = await response.json();
                displayHistory(data.data.records || []);
            } catch (error) {
                showAlert('error', 'Êó†Ê≥ïÂä†ËΩΩÂ§±Ë¥•‰ªªÂä°');
            }
        }

        // ÊµãËØïÂêåÊ≠•
        async function testSync(platform, documentId) {
            try {
                showAlert('info', `ÂºÄÂßãÊµãËØï ${platform} ÊñáÊ°£ ${documentId} ÁöÑÂêåÊ≠•ÂäüËÉΩ...`);
                
                // Á°ÆÂÆöÁõÆÊ†áÂπ≥Âè∞
                const targetPlatform = platform === 'feishu' ? 'notion' : 'feishu';
                
                const formData = {
                    source_platform: platform,
                    target_platform: targetPlatform,
                    source_id: documentId,
                    content_type: 'document'
                };
                
                const response = await fetch('/api/sync/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', `ÊµãËØïÂêåÊ≠•ÊàêÂäüÔºÅÂêåÊ≠•ËÆ∞ÂΩïID: ${result.sync_record_id}`);
                    loadDashboardData();
                    
                    // ÂàáÊç¢Âà∞ÂéÜÂè≤Ê†áÁ≠æÈ°µÊòæÁ§∫ÁªìÊûú
                    setTimeout(() => {
                        showTab('history');
                        loadHistory();
                    }, 1000);
                } else {
                    showAlert('error', `ÊµãËØïÂêåÊ≠•Â§±Ë¥•: ${result.error}`);
                }
            } catch (error) {
                console.error('ÊµãËØïÂêåÊ≠•Â§±Ë¥•:', error);
                showAlert('error', 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }


        // ÈáçËØïÂêåÊ≠•
        async function retrySync(recordId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÈáçËØïËøô‰∏™ÂêåÊ≠•‰ªªÂä°ÂêóÔºü')) {
                return;
            }
            
            try {
                showAlert('info', `Ê≠£Âú®ÈáçËØïÂêåÊ≠•‰ªªÂä° ${recordId}...`);
                
                const response = await fetch(`/api/sync/retry/${recordId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    if (result.result && result.result.success) {
                        showAlert('success', `ÂêåÊ≠•‰ªªÂä° ${recordId} ÈáçËØïÊàêÂäüÔºÅ`);
                    } else {
                        showAlert('warning', `ÂêåÊ≠•‰ªªÂä° ${recordId} ÈáçËØïÂÆåÊàêÔºå‰ΩÜÂèØËÉΩÊúâÈóÆÈ¢ò`);
                    }
                    
                    // Âà∑Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïÂíåÁªüËÆ°
                    setTimeout(() => {
                        loadHistory();
                        loadDashboardData();
                    }, 1000);
                } else {
                    showAlert('error', `ÈáçËØïÂ§±Ë¥•: ${result.error || 'Êú™Áü•ÈîôËØØ'}`);
                }
                
            } catch (error) {
                console.error('ÈáçËØïÂêåÊ≠•Â§±Ë¥•:', error);
                showAlert('error', 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ÊòæÁ§∫Âà†Èô§ËèúÂçï
        function showDeleteMenu() {
            document.getElementById('deleteMenu').classList.remove('hidden');
        }

        // ÈöêËóèÂà†Èô§ËèúÂçï
        function hideDeleteMenu() {
            document.getElementById('deleteMenu').classList.add('hidden');
            // ÈáçÁΩÆÊâπÈáèÂà†Èô§Ê®°Âºè
            const batchCheckbox = document.getElementById('enableBatchDelete');
            if (batchCheckbox && batchCheckbox.checked) {
                batchCheckbox.checked = false;
                toggleBatchSelect();
            }
        }

        // ÂàáÊç¢ÊâπÈáèÈÄâÊã©Ê®°Âºè
        function toggleBatchSelect() {
            loadHistory(); // ÈáçÊñ∞Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï‰ª•ÂàáÊç¢ÊòæÁ§∫Ê®°Âºè
        }

        // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâ
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllRecords');
            const checkboxes = document.querySelectorAll('.record-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        // Âà†Èô§ÂçïÊù°ËÆ∞ÂΩï
        async function deleteRecord(recordId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂêåÊ≠•ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
                return;
            }

            try {
                const response = await fetch(`/api/sync/record/${recordId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', 'ËÆ∞ÂΩïÂà†Èô§ÊàêÂäü');
                    loadHistory();
                    loadDashboardData();
                } else {
                    showAlert('error', result.message || 'Âà†Èô§Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Âà†Èô§ËÆ∞ÂΩïÂ§±Ë¥•:', error);
                showAlert('error', 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ÊâπÈáèÂà†Èô§ÈÄâ‰∏≠ËÆ∞ÂΩï
        async function deleteBatchRecords() {
            const checkboxes = document.querySelectorAll('.record-checkbox:checked');
            const recordIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (recordIds.length === 0) {
                showAlert('warning', 'ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑËÆ∞ÂΩï');
                return;
            }

            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${recordIds.length} Êù°ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`)) {
                return;
            }

            try {
                const response = await fetch('/api/sync/records/batch', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        record_ids: recordIds
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', result.message);
                    loadHistory();
                    loadDashboardData();
                } else {
                    showAlert('error', result.message || 'ÊâπÈáèÂà†Èô§Â§±Ë¥•');
                }
            } catch (error) {
                console.error('ÊâπÈáèÂà†Èô§Â§±Ë¥•:', error);
                showAlert('error', 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // Ê∏ÖÁ©∫ËÆ∞ÂΩïÔºàÊåâÁä∂ÊÄÅÔºâ
        async function clearRecords(status) {
            let confirmMessage = '';
            switch (status) {
                case 'success':
                    confirmMessage = 'Á°ÆÂÆöË¶ÅÂà†Èô§ÊâÄÊúâÊàêÂäüÁöÑÂêåÊ≠•ËÆ∞ÂΩïÂêóÔºü';
                    break;
                case 'failed':
                    confirmMessage = 'Á°ÆÂÆöË¶ÅÂà†Èô§ÊâÄÊúâÂ§±Ë¥•ÁöÑÂêåÊ≠•ËÆ∞ÂΩïÂêóÔºü';
                    break;
                case 'pending':
                    confirmMessage = 'Á°ÆÂÆöË¶ÅÂà†Èô§ÊâÄÊúâÂæÖÂ§ÑÁêÜÁöÑÂêåÊ≠•ËÆ∞ÂΩïÂêóÔºü';
                    break;
                case 'all':
                    confirmMessage = 'Á°ÆÂÆöË¶ÅÂà†Èô§ÊâÄÊúâÂêåÊ≠•ËÆ∞ÂΩïÂêóÔºüËøôÂ∞ÜÊ∏ÖÁ©∫Êï¥‰∏™ÂêåÊ≠•ÂéÜÂè≤ÔºÅ';
                    break;
                default:
                    showAlert('error', 'Êó†ÊïàÁöÑÁä∂ÊÄÅÂèÇÊï∞');
                    return;
            }

            if (!confirm(confirmMessage + ' Ê≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ')) {
                return;
            }

            try {
                const response = await fetch(`/api/sync/records/clear?status=${status}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', result.message);
                    hideDeleteMenu(); // ÈöêËóèÂà†Èô§ËèúÂçï
                    loadHistory();
                    loadDashboardData();
                } else {
                    showAlert('error', result.message || 'Ê∏ÖÁ©∫ËÆ∞ÂΩïÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Ê∏ÖÁ©∫ËÆ∞ÂΩïÂ§±Ë¥•:', error);
                showAlert('error', 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ÂõæÁâáÁÆ°ÁêÜÁõ∏ÂÖ≥ÂáΩÊï∞
        async function loadImageStats() {
            try {
                const response = await fetch('/api/images/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.data.summary;
                    document.getElementById('totalImages').textContent = stats.total_images || 0;
                    document.getElementById('storageUsage').textContent = (stats.total_size_mb || 0) + ' MB';
                    document.getElementById('totalAccess').textContent = stats.total_access_count || 0;
                    document.getElementById('avgSize').textContent = (stats.average_size_kb || 0) + ' KB';
                    
                    // Êõ¥Êñ∞ÂõæÁâáÂàóË°®
                    displayImageManagement(data.data);
                } else {
                    console.error('Ëé∑ÂèñÂõæÁâáÁªüËÆ°Â§±Ë¥•:', data.message);
                }
            } catch (error) {
                console.error('ÂõæÁâáÁªüËÆ°Âä†ËΩΩÂ§±Ë¥•:', error);
            }
        }
        
        // ÊòæÁ§∫ÂõæÁâáÁÆ°ÁêÜÁïåÈù¢
        function displayImageManagement(data) {
            const container = document.getElementById('imagesContainer');
            
            if (!data || data.summary.total_images === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ÊöÇÊó†ÂõæÁâáÊï∞ÊçÆ</h3>
                        <p>ÂΩìÊúâÂõæÁâá‰∏ä‰º†Êó∂ÔºåÁõ∏ÂÖ≥ÁªüËÆ°‰ø°ÊÅØÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå</p>
                    </div>
                `;
                return;
            }
            
            let storageInfo = '';
            if (data.storage_distribution) {
                storageInfo = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div class="stat-card">
                            <h3>Êú¨Âú∞Â≠òÂÇ®</h3>
                            <div class="value">${data.storage_distribution.local_count || 0}</div>
                            <div class="label">Âº†ÂõæÁâá</div>
                        </div>
                        <div class="stat-card">
                            <h3>‰∫ëÁ´ØÂ≠òÂÇ®</h3>
                            <div class="value">${data.storage_distribution.qiniu_count || 0}</div>
                            <div class="label">Âº†ÂõæÁâá</div>
                        </div>
                    </div>
                `;
            }
            
            let recentImages = '';
            if (data.recent_images && data.recent_images.length > 0) {
                recentImages = `
                    <h3 style="margin: 30px 0 20px 0; color: #4a5568;">üì∏ ÊúÄËøë‰∏ä‰º†ÁöÑÂõæÁâá</h3>
                    <div style="background: #f7fafc; border-radius: 8px; overflow: hidden;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Êñá‰ª∂ÂìàÂ∏å</th>
                                    <th>Â§ßÂ∞è</th>
                                    <th>Á±ªÂûã</th>
                                    <th>Â≠òÂÇ®‰ΩçÁΩÆ</th>
                                    <th>ËÆøÈóÆÊ¨°Êï∞</th>
                                    <th>‰∏ä‰º†Êó∂Èó¥</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.recent_images.map(img => `
                                    <tr>
                                        <td>
                                            <span style="font-family: monospace; font-size: 12px; background: #e2e8f0; padding: 2px 6px; border-radius: 4px;">
                                                ${img.file_hash.substring(0, 8)}...
                                            </span>
                                        </td>
                                        <td>${Math.round(img.file_size / 1024)} KB</td>
                                        <td>
                                            <span class="status-badge status-info">${img.file_type}</span>
                                        </td>
                                        <td>
                                            <span class="status-badge ${img.storage_type === 'local' ? 'status-warning' : 'status-success'}">
                                                ${img.storage_type === 'local' ? 'Êú¨Âú∞' : '‰∫ëÁ´Ø'}
                                            </span>
                                        </td>
                                        <td>${img.access_count}</td>
                                        <td>${new Date(img.upload_time).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            container.innerHTML = `
                ${storageInfo}
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin: 20px 0;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üí° ÂõæÁâáÂ≠òÂÇ®ËØ¥Êòé</h4>
                    <p style="color: #856404; margin: 0;">
                        <strong>Êú¨Âú∞Â≠òÂÇ®:</strong> ${data.summary.local_storage_mb || 0} MB - 
                        <strong>‰∫ëÁ´ØÂ≠òÂÇ®:</strong> ${data.summary.total_size_mb || 0} MB
                    </p>
                </div>
                ${recentImages}
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="loadFullImageList()">
                        üìã Êü•ÁúãÂÆåÊï¥ÂõæÁâáÂàóË°®
                    </button>
                </div>
            `;
        }
        
        // Âä†ËΩΩÂÆåÊï¥ÂõæÁâáÂàóË°®
        async function loadFullImageList() {
            try {
                const response = await fetch('/api/images?limit=50');
                const data = await response.json();
                
                if (data.success) {
                    showImageListModal(data.data);
                } else {
                    showAlert('error', 'Ëé∑ÂèñÂõæÁâáÂàóË°®Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂõæÁâáÂàóË°®Â§±Ë¥•:', error);
                showAlert('error', 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }
        
        // ÊòæÁ§∫ÂõæÁâáÂàóË°®Ê®°ÊÄÅÊ°Ü
        function showImageListModal(data) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
                    <h2 style="margin-bottom: 20px;">üì∏ ÂõæÁâáÁÆ°ÁêÜÂàóË°®</h2>
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ÂìàÂ∏åÂÄº</th>
                                    <th>Â§ßÂ∞è</th>
                                    <th>Â≠òÂÇ®</th>
                                    <th>ËÆøÈóÆ</th>
                                    <th>‰∏ä‰º†Êó∂Èó¥</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.images.map(img => `
                                    <tr>
                                        <td>
                                            <span style="font-family: monospace; font-size: 11px;">
                                                ${img.file_hash.substring(0, 12)}...
                                            </span>
                                        </td>
                                        <td>${img.file_size_kb} KB</td>
                                        <td>
                                            <span class="status-badge ${img.storage_type === 'local' ? 'status-warning' : 'status-success'}">
                                                ${img.storage_type === 'local' ? 'Êú¨Âú∞' : '‰∫ëÁ´Ø'}
                                            </span>
                                        </td>
                                        <td>${img.access_count}</td>
                                        <td style="font-size: 12px;">${new Date(img.upload_time).toLocaleDateString()}</td>
                                        <td>
                                            ${img.local_url ? `<a href="${img.local_url}" target="_blank" class="btn btn-sm">Êü•Áúã</a>` : ''}
                                            ${img.qiniu_url ? `<a href="${img.qiniu_url}" target="_blank" class="btn btn-sm">CDN</a>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <p style="color: #718096; font-size: 14px;">
                            ÂÖ± ${data.pagination.total} Âº†ÂõæÁâáÔºåÂΩìÂâçÊòæÁ§∫ ${data.images.length} Âº†
                        </p>
                    </div>
                    <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeImageListModal()">ÂÖ≥Èó≠</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ÁÇπÂáªÈÅÆÁΩ©ÂÖ≥Èó≠
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeImageListModal();
                }
            });
        }
        
        // ÂÖ≥Èó≠ÂõæÁâáÂàóË°®Ê®°ÊÄÅÊ°Ü
        function closeImageListModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }
    </script>
</body>
</html>