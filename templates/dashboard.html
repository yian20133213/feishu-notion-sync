<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£ä¹¦-NotionåŒæ­¥ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            line-height: 1.6;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        .main-content {
            padding: 30px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
            transition: transform 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-card h3 {
            color: #2d3748;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        .stat-card .label {
            color: #718096;
            font-size: 14px;
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #2d3748;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        .btn-success {
            background: #48bb78;
        }
        .btn-success:hover {
            background: #38a169;
        }
        .btn-danger {
            background: #f56565;
        }
        .btn-danger:hover {
            background: #e53e3e;
        }
        .btn-secondary {
            background: #718096;
        }
        .btn-secondary:hover {
            background: #4a5568;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th,
        .table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .status-success {
            background: #c6f6d5;
            color: #22543d;
        }
        .status-warning {
            background: #faf089;
            color: #744210;
        }
        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }
        .status-info {
            background: #bee3f8;
            color: #2a4365;
        }
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        .alert-info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }
        .hidden {
            display: none;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: none;
            border: none;
            color: #718096;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .tab.active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .config-item {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .config-actions {
            margin-top: 15px;
        }
        .config-actions button {
            margin-right: 10px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }
        .empty-state h3 {
            margin-bottom: 10px;
            color: #4a5568;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>ğŸ”„ é£ä¹¦-NotionåŒæ­¥ç®¡ç†ç³»ç»Ÿ</h1>
            <p>å®æ—¶åŒæ­¥ | æ™ºèƒ½ç®¡ç† | é«˜æ•ˆåä½œ</p>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>æ€»åŒæ­¥æ¬¡æ•°</h3>
                    <div class="value" id="totalSyncs">0</div>
                    <div class="label">æ¬¡åŒæ­¥æ“ä½œ</div>
                </div>
                <div class="stat-card">
                    <h3>æˆåŠŸç‡</h3>
                    <div class="value" id="successRate">0%</div>
                    <div class="label">åŒæ­¥æˆåŠŸç‡</div>
                </div>
                <div class="stat-card">
                    <h3>å¾…å¤„ç†ä»»åŠ¡</h3>
                    <div class="value" id="pendingTasks">0</div>
                    <div class="label">ä¸ªç­‰å¾…åŒæ­¥</div>
                </div>
                <div class="stat-card">
                    <h3>å¯ç”¨é…ç½®</h3>
                    <div class="value" id="enabledConfigs">0</div>
                    <div class="label">ä¸ªæ–‡æ¡£é…ç½®</div>
                </div>
            </div>

            <!-- ç³»ç»ŸçŠ¶æ€ -->
            <div class="section">
                <h2>ğŸ” ç³»ç»ŸçŠ¶æ€</h2>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div>
                        <strong>æ•°æ®åº“:</strong>
                        <span class="status-badge status-success" id="dbStatus">è¿æ¥æ­£å¸¸</span>
                    </div>
                    <div>
                        <strong>é£ä¹¦API:</strong>
                        <span class="status-badge status-success" id="feishuStatus">è¿æ¥æ­£å¸¸</span>
                    </div>
                    <div>
                        <strong>Notion API:</strong>
                        <span class="status-badge status-success" id="notionStatus">é…ç½®æ­£å¸¸</span>
                    </div>
                    <div>
                        <strong>ä¸ƒç‰›äº‘:</strong>
                        <span class="status-badge status-success" id="qiniuStatus">é…ç½®æ­£å¸¸</span>
                    </div>
                </div>
            </div>

            <!-- åŠŸèƒ½æ ‡ç­¾é¡µ -->
            <div class="section">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('configs')">ğŸ“‹ åŒæ­¥é…ç½®</button>
                    <button class="tab" onclick="showTab('trigger')">ğŸš€ æ‰‹åŠ¨åŒæ­¥</button>
                    <button class="tab" onclick="showTab('history')">ğŸ“Š åŒæ­¥å†å²</button>
                    <button class="tab" onclick="showTab('images')">ğŸ–¼ï¸ å›¾ç‰‡ç®¡ç†</button>
                </div>

                <!-- åŒæ­¥é…ç½®æ ‡ç­¾é¡µ -->
                <div id="configs" class="tab-content active">
                    <h2>ğŸ“‹ åŒæ­¥é…ç½®ç®¡ç†</h2>
                    
                    <!-- æ·»åŠ æ–°é…ç½® -->
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px; color: #4a5568;">â• æ·»åŠ æ–°çš„åŒæ­¥é…ç½®</h3>
                        <form id="addConfigForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="platform">å¹³å°</label>
                                    <select id="platform" class="form-control" required>
                                        <option value="">é€‰æ‹©å¹³å°</option>
                                        <option value="feishu">é£ä¹¦ (Feishu)</option>
                                        <option value="notion">Notion</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="documentId">æ–‡æ¡£/é¡µé¢ID</label>
                                    <input type="text" id="documentId" class="form-control" 
                                           placeholder="è¾“å…¥æ–‡æ¡£IDæˆ–é¡µé¢ID" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="syncDirection">åŒæ­¥æ–¹å‘</label>
                                    <select id="syncDirection" class="form-control" required>
                                        <option value="">é€‰æ‹©åŒæ­¥æ–¹å‘</option>
                                        <option value="feishu_to_notion">é£ä¹¦ â†’ Notion</option>
                                        <option value="notion_to_feishu">Notion â†’ é£ä¹¦</option>
                                        <option value="bidirectional">åŒå‘åŒæ­¥</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="autoSync" checked>
                                        å¯ç”¨è‡ªåŠ¨åŒæ­¥
                                    </label>
                                    <br>
                                    <label>
                                        <input type="checkbox" id="isEnabled" checked>
                                        å¯ç”¨æ­¤é…ç½®
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                â• æ·»åŠ é…ç½®
                            </button>
                        </form>
                    </div>

                    <!-- ç°æœ‰é…ç½®åˆ—è¡¨ -->
                    <div id="configsList">
                        <h3 style="margin-bottom: 20px; color: #4a5568;">ğŸ“‹ ç°æœ‰åŒæ­¥é…ç½®</h3>
                        <div id="configsContainer">
                            <!-- é…ç½®é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>

                <!-- æ‰‹åŠ¨åŒæ­¥æ ‡ç­¾é¡µ -->
                <div id="trigger" class="tab-content">
                    <h2>ğŸš€ æ‰‹åŠ¨è§¦å‘åŒæ­¥</h2>
                    
                    <div style="background: #fef5e7; padding: 20px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #f6ad55;">
                        <h3 style="color: #c05621; margin-bottom: 10px;">âš ï¸ ä½¿ç”¨è¯´æ˜</h3>
                        <ul style="color: #9c4221; margin-left: 20px;">
                            <li>æ‰‹åŠ¨åŒæ­¥é€‚ç”¨äºéœ€è¦ç«‹å³åŒæ­¥çš„åœºæ™¯</li>
                            <li>é£ä¹¦â†’Notionï¼šå»ºè®®ç”¨äºå†…å®¹å‘å¸ƒ</li>
                            <li>Notionâ†’é£ä¹¦ï¼šéœ€è¦è°¨æ…æ“ä½œï¼Œé¿å…è¦†ç›–é‡è¦å†…å®¹</li>
                            <li>ç¡®ä¿æ–‡æ¡£IDæ­£ç¡®ï¼Œé¿å…åŒæ­¥åˆ°é”™è¯¯ç›®æ ‡</li>
                        </ul>
                    </div>

                    <form id="triggerSyncForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="triggerSourcePlatform">æºå¹³å°</label>
                                <select id="triggerSourcePlatform" class="form-control" required>
                                    <option value="">é€‰æ‹©æºå¹³å°</option>
                                    <option value="feishu" selected>é£ä¹¦ (Feishu)</option>
                                    <option value="notion">Notion</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="triggerTargetPlatform">ç›®æ ‡å¹³å°</label>
                                <select id="triggerTargetPlatform" class="form-control" required>
                                    <option value="">é€‰æ‹©ç›®æ ‡å¹³å°</option>
                                    <option value="feishu">é£ä¹¦ (Feishu)</option>
                                    <option value="notion" selected>Notion</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="triggerSourceId">æºæ–‡æ¡£ID</label>
                                <input type="text" id="triggerSourceId" class="form-control" 
                                       placeholder="è¾“å…¥è¦åŒæ­¥çš„æ–‡æ¡£ID" required>
                            </div>
                            <div class="form-group">
                                <label for="triggerContentType">å†…å®¹ç±»å‹</label>
                                <select id="triggerContentType" class="form-control" required>
                                    <option value="document" selected>æ–‡æ¡£ (Document)</option>
                                    <option value="database">æ•°æ®åº“/è¡¨æ ¼ (Database)</option>
                                    <option value="page">é¡µé¢ (Page)</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">
                            ğŸš€ ç«‹å³åŒæ­¥
                        </button>
                    </form>

                    <!-- åŒæ­¥ç»“æœæ˜¾ç¤º -->
                    <div id="syncResult" class="hidden" style="margin-top: 30px;">
                        <!-- ç»“æœå°†é€šè¿‡JavaScriptæ˜¾ç¤º -->
                    </div>
                </div>

                <!-- åŒæ­¥å†å²æ ‡ç­¾é¡µ -->
                <div id="history" class="tab-content">
                    <h2>ğŸ“Š åŒæ­¥å†å²è®°å½•</h2>
                    
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button class="btn btn-secondary" onclick="refreshHistory()">
                            ğŸ”„ åˆ·æ–°å†å²
                        </button>
                        <button class="btn btn-secondary" onclick="showPendingTasks()">
                            â³ å¾…å¤„ç†ä»»åŠ¡
                        </button>
                        <button class="btn btn-secondary" onclick="showFailedTasks()">
                            âŒ å¤±è´¥ä»»åŠ¡
                        </button>
                        <div style="margin-left: auto; display: flex; gap: 10px;">
                            <button class="btn btn-danger" onclick="showDeleteMenu()">
                                ğŸ—‘ï¸ åˆ é™¤è®°å½•
                            </button>
                        </div>
                    </div>

                    <!-- åˆ é™¤èœå• -->
                    <div id="deleteMenu" class="hidden" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
                        <h4 style="color: #dc3545; margin-bottom: 15px;">ğŸ—‘ï¸ åˆ é™¤å†å²è®°å½•</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                            <button class="btn btn-danger" onclick="clearRecords('success')">
                                åˆ é™¤æˆåŠŸè®°å½•
                            </button>
                            <button class="btn btn-danger" onclick="clearRecords('failed')">
                                åˆ é™¤å¤±è´¥è®°å½•
                            </button>
                            <button class="btn btn-danger" onclick="clearRecords('pending')">
                                åˆ é™¤å¾…å¤„ç†è®°å½•
                            </button>
                            <button class="btn btn-danger" onclick="clearRecords('all')">
                                åˆ é™¤å…¨éƒ¨è®°å½•
                            </button>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="hideDeleteMenu()">
                                å–æ¶ˆ
                            </button>
                            <label style="margin-left: auto; color: #6c757d; font-size: 14px;">
                                <input type="checkbox" id="enableBatchDelete" onchange="toggleBatchSelect()"> æ‰¹é‡é€‰æ‹©åˆ é™¤
                            </label>
                        </div>
                    </div>

                    <div id="historyContainer">
                        <!-- å†å²è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>

                <!-- å›¾ç‰‡ç®¡ç†æ ‡ç­¾é¡µ -->
                <div id="images" class="tab-content">
                    <h2>ğŸ–¼ï¸ å›¾ç‰‡å­˜å‚¨ç®¡ç†</h2>
                    
                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <h3>å›¾ç‰‡æ€»æ•°</h3>
                            <div class="value" id="totalImages">0</div>
                            <div class="label">å¼ å›¾ç‰‡</div>
                        </div>
                        <div class="stat-card">
                            <h3>å­˜å‚¨ä½¿ç”¨</h3>
                            <div class="value" id="storageUsage">0 MB</div>
                            <div class="label">å­˜å‚¨ç©ºé—´</div>
                        </div>
                        <div class="stat-card">
                            <h3>è®¿é—®æ¬¡æ•°</h3>
                            <div class="value" id="totalAccess">0</div>
                            <div class="label">æ¬¡è®¿é—®</div>
                        </div>
                        <div class="stat-card">
                            <h3>å¹³å‡å¤§å°</h3>
                            <div class="value" id="avgSize">0 KB</div>
                            <div class="label">å•å¼ å¹³å‡</div>
                        </div>
                    </div>

                    <div style="background: #e6f7ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #1890ff;">
                        <h3 style="color: #003a8c; margin-bottom: 10px;">ğŸ’¡ å›¾ç‰‡å¤„ç†è¯´æ˜</h3>
                        <ul style="color: #0050b3; margin-left: 20px;">
                            <li>ç³»ç»Ÿè‡ªåŠ¨å°†å›¾ç‰‡å‹ç¼©ä¸ºWebPæ ¼å¼ï¼Œå¯å‡å°‘70%çš„å­˜å‚¨ç©ºé—´</li>
                            <li>ä½¿ç”¨MD5æ ¡éªŒå®ç°å»é‡ï¼Œç›¸åŒå›¾ç‰‡åªå­˜å‚¨ä¸€ä»½</li>
                            <li>å›¾ç‰‡ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘CDNï¼Œæä¾›å¿«é€Ÿè®¿é—®</li>
                            <li>å…è´¹é¢åº¦ï¼š10GBå­˜å‚¨ + 10GB CDNæµé‡/æœˆ</li>
                        </ul>
                    </div>

                    <div id="imagesContainer">
                        <!-- å›¾ç‰‡ç»Ÿè®¡å’Œç®¡ç†ç•Œé¢ -->
                        <div class="empty-state">
                            <h3>æš‚æ— å›¾ç‰‡æ•°æ®</h3>
                            <p>å½“æœ‰å›¾ç‰‡ä¸Šä¼ æ—¶ï¼Œç›¸å…³ç»Ÿè®¡ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // å…¨å±€çŠ¶æ€
        let dashboardData = {};
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            loadConfigs();
            
            // è®¾ç½®è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('addConfigForm').addEventListener('submit', handleAddConfig);
            document.getElementById('triggerSyncForm').addEventListener('submit', handleTriggerSync);
        });

        // æ˜¾ç¤ºæ ‡ç­¾é¡µ
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½ç›¸åº”æ•°æ®
            switch(tabName) {
                case 'configs':
                    loadConfigs();
                    break;
                case 'history':
                    loadHistory();
                    break;
                case 'images':
                    loadImageStats();
                    break;
            }
        }

        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard');
                dashboardData = await response.json();
                
                updateStats();
                updateSystemStatus();
            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥:', error);
                showAlert('error', 'æ— æ³•åŠ è½½ç³»ç»Ÿæ•°æ®ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€');
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            const summary = dashboardData.summary || {};
            
            document.getElementById('totalSyncs').textContent = summary.total_syncs || 0;
            document.getElementById('successRate').textContent = (summary.success_rate || 0) + '%';
            document.getElementById('pendingTasks').textContent = summary.pending_tasks || 0;
            document.getElementById('enabledConfigs').textContent = summary.enabled_configs || 0;
        }

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus() {
            const status = dashboardData.system_status || {};
            
            updateStatusBadge('dbStatus', status.database);
            updateStatusBadge('feishuStatus', status.feishu_api);
            updateStatusBadge('notionStatus', status.notion_api);
            updateStatusBadge('qiniuStatus', status.qiniu_storage);
        }

        // æ›´æ–°çŠ¶æ€æ ‡è¯†
        function updateStatusBadge(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = 'status-badge';
            
            if (status === 'connected' || status === 'configured') {
                element.classList.add('status-success');
                element.textContent = 'è¿æ¥æ­£å¸¸';
            } else if (status === 'error') {
                element.classList.add('status-error');
                element.textContent = 'è¿æ¥å¤±è´¥';
            } else {
                element.classList.add('status-warning');
                element.textContent = 'çŠ¶æ€æœªçŸ¥';
            }
        }

        // åŠ è½½é…ç½®åˆ—è¡¨
        async function loadConfigs() {
            try {
                const response = await fetch('/api/sync/configs');
                const data = await response.json();
                
                displayConfigs(data.data || []);
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                showAlert('error', 'æ— æ³•åŠ è½½åŒæ­¥é…ç½®');
            }
        }

        // æ˜¾ç¤ºé…ç½®åˆ—è¡¨
        function displayConfigs(configs) {
            const container = document.getElementById('configsContainer');
            
            if (configs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— åŒæ­¥é…ç½®</h3>
                        <p>è¯·åœ¨ä¸Šæ–¹æ·»åŠ æ–°çš„åŒæ­¥é…ç½®</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = configs.map(config => `
                <div class="config-item">
                    <div style="display: flex; justify-content: between; align-items: center;">
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 10px; color: #2d3748;">
                                ${config.platform === 'feishu' ? 'ğŸ“± é£ä¹¦' : 'ğŸ“‹ Notion'} æ–‡æ¡£é…ç½®
                            </h4>
                            <p><strong>æ–‡æ¡£ID:</strong> ${config.document_id}</p>
                            <p><strong>åŒæ­¥æ–¹å‘:</strong> ${getSyncDirectionText(config.sync_direction)}</p>
                            <p><strong>çŠ¶æ€:</strong> 
                                <span class="status-badge ${config.is_sync_enabled ? 'status-success' : 'status-error'}">
                                    ${config.is_sync_enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}
                                </span>
                                ${config.auto_sync ? '<span class="status-badge status-info">è‡ªåŠ¨åŒæ­¥</span>' : '<span class="status-badge status-warning">æ‰‹åŠ¨åŒæ­¥</span>'}
                            </p>
                        </div>
                    </div>
                    <div class="config-actions">
                        <button class="btn ${config.is_sync_enabled ? 'btn-danger' : 'btn-success'}" 
                                onclick="toggleConfig(${config.id}, ${!config.is_sync_enabled})">
                            ${config.is_sync_enabled ? 'ğŸ”¥ ç¦ç”¨' : 'âœ… å¯ç”¨'}
                        </button>
                        <button class="btn btn-secondary" onclick="editConfig(${config.id})">
                            âœï¸ ç¼–è¾‘
                        </button>
                        <button class="btn btn-danger" onclick="deleteConfig(${config.id})">
                            ğŸ—‘ï¸ åˆ é™¤
                        </button>
                        <button class="btn" onclick="testSync('${config.platform}', '${config.document_id}')">
                            ğŸ§ª æµ‹è¯•åŒæ­¥
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // è·å–åŒæ­¥æ–¹å‘æ–‡æœ¬
        function getSyncDirectionText(direction) {
            const directions = {
                'feishu_to_notion': 'é£ä¹¦ â†’ Notion',
                'notion_to_feishu': 'Notion â†’ é£ä¹¦',
                'bidirectional': 'åŒå‘åŒæ­¥'
            };
            return directions[direction] || direction;
        }

        // å¤„ç†æ·»åŠ é…ç½®
        async function handleAddConfig(event) {
            event.preventDefault();
            
            const formData = {
                platform: document.getElementById('platform').value,
                document_id: document.getElementById('documentId').value,
                sync_direction: document.getElementById('syncDirection').value,
                is_sync_enabled: document.getElementById('isEnabled').checked,
                auto_sync: document.getElementById('autoSync').checked
            };

            try {
                const response = await fetch('/api/sync/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', 'åŒæ­¥é…ç½®æ·»åŠ æˆåŠŸï¼');
                    document.getElementById('addConfigForm').reset();
                    loadConfigs();
                    loadDashboardData();
                } else {
                    showAlert('error', result.error || 'æ·»åŠ é…ç½®å¤±è´¥');
                }
            } catch (error) {
                console.error('æ·»åŠ é…ç½®å¤±è´¥:', error);
                showAlert('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // å¤„ç†è§¦å‘åŒæ­¥
        let syncInProgress = false;  // é˜²é‡å¤æäº¤æ ‡å¿—
        
        async function handleTriggerSync(event) {
            event.preventDefault();
            
            // é˜²é‡å¤æäº¤æ£€æŸ¥
            if (syncInProgress) {
                showSyncResult('warning', 'åŒæ­¥æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤');
                return;
            }
            
            const submitButton = document.querySelector('#triggerSyncForm button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            try {
                // è®¾ç½®æäº¤çŠ¶æ€
                syncInProgress = true;
                submitButton.disabled = true;
                submitButton.innerHTML = 'ğŸ”„ åŒæ­¥ä¸­...';
                
                const formData = {
                    source_platform: document.getElementById('triggerSourcePlatform').value,
                    target_platform: document.getElementById('triggerTargetPlatform').value,
                    source_id: document.getElementById('triggerSourceId').value,
                    content_type: document.getElementById('triggerContentType').value
                };

                const response = await fetch('/api/sync/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showSyncResult('success', 'åŒæ­¥ä»»åŠ¡å·²åˆ›å»º', result);
                    loadDashboardData();
                    // æ¸…ç©ºè¡¨å•æºæ–‡æ¡£IDå­—æ®µ
                    document.getElementById('triggerSourceId').value = '';
                } else {
                    showSyncResult('error', result.error || 'åŒæ­¥å¤±è´¥', result);
                }
            } catch (error) {
                console.error('è§¦å‘åŒæ­¥å¤±è´¥:', error);
                showSyncResult('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            } finally {
                // æ¢å¤æäº¤çŠ¶æ€
                syncInProgress = false;
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
            }
        }

        // æ˜¾ç¤ºåŒæ­¥ç»“æœ
        function showSyncResult(type, message, result = {}) {
            const container = document.getElementById('syncResult');
            
            // å¤„ç†ä¸åŒç±»å‹çš„æ ·å¼
            let alertClass, icon, title;
            switch(type) {
                case 'success':
                    alertClass = 'alert-success';
                    icon = 'âœ…';
                    title = 'åŒæ­¥æˆåŠŸ';
                    break;
                case 'warning':
                    alertClass = 'alert-warning';
                    icon = 'âš ï¸';
                    title = 'æ³¨æ„';
                    break;
                case 'error':
                default:
                    alertClass = 'alert-danger';
                    icon = 'âŒ';
                    title = 'åŒæ­¥å¤±è´¥';
            }
            
            container.className = `alert ${alertClass}`;
            container.innerHTML = `
                <h4>${icon} ${title}</h4>
                <p>${message}</p>
                ${result.sync_record_id ? `<p><strong>åŒæ­¥è®°å½•ID:</strong> ${result.sync_record_id}</p>` : ''}
                ${result.timestamp ? `<p><strong>æ—¶é—´:</strong> ${new Date(result.timestamp).toLocaleString()}</p>` : ''}
            `;
            container.classList.remove('hidden');
            
            // è­¦å‘Šæ¶ˆæ¯3ç§’åè‡ªåŠ¨éšè—
            if (type === 'warning') {
                setTimeout(() => {
                    container.classList.add('hidden');
                }, 3000);
            }
        }


        // åˆ‡æ¢é…ç½®å¯ç”¨çŠ¶æ€
        async function toggleConfig(configId, enabled) {
            try {
                const response = await fetch(`/api/sync/config/${configId}/toggle`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('success', data.message);
                    loadConfigs(); // ç«‹å³åˆ·æ–°é…ç½®åˆ—è¡¨
                    loadDashboardData(); // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                } else {
                    showAlert('error', data.message || 'æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ‡æ¢é…ç½®çŠ¶æ€å¤±è´¥:', error);
                showAlert('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // ç¼–è¾‘é…ç½®
        async function editConfig(configId) {
            try {
                const response = await fetch(`/api/sync/config/${configId}`);
                const data = await response.json();
                
                if (data.success) {
                    const config = data.data;
                    showEditModal(config);
                } else {
                    showAlert('error', data.message || 'æ— æ³•åŠ è½½é…ç½®ä¿¡æ¯');
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®ä¿¡æ¯å¤±è´¥:', error);
                showAlert('error', 'æ— æ³•åŠ è½½é…ç½®ä¿¡æ¯');
            }
        }

        // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
        function showEditModal(config) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>ç¼–è¾‘åŒæ­¥é…ç½®</h3>
                    <form id="editConfigForm">
                        <div class="form-group">
                            <label for="editPlatform">å¹³å°</label>
                            <select id="editPlatform" class="form-control" required>
                                <option value="feishu" ${config.platform === 'feishu' ? 'selected' : ''}>é£ä¹¦ (Feishu)</option>
                                <option value="notion" ${config.platform === 'notion' ? 'selected' : ''}>Notion</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editDocumentId">æ–‡æ¡£ID</label>
                            <input type="text" id="editDocumentId" class="form-control" 
                                   value="${config.document_id}" required>
                        </div>
                        <div class="form-group">
                            <label for="editSyncDirection">åŒæ­¥æ–¹å‘</label>
                            <select id="editSyncDirection" class="form-control" required>
                                <option value="feishu_to_notion" ${config.sync_direction === 'feishu_to_notion' ? 'selected' : ''}>é£ä¹¦ â†’ Notion</option>
                                <option value="notion_to_feishu" ${config.sync_direction === 'notion_to_feishu' ? 'selected' : ''}>Notion â†’ é£ä¹¦</option>
                                <option value="bidirectional" ${config.sync_direction === 'bidirectional' ? 'selected' : ''}>åŒå‘åŒæ­¥</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editIsEnabled" ${config.is_sync_enabled ? 'checked' : ''}> å¯ç”¨åŒæ­¥
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="editAutoSync" ${config.auto_sync ? 'checked' : ''}> è‡ªåŠ¨åŒæ­¥
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                            <button type="submit" class="btn btn-success">ä¿å­˜</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // å¤„ç†è¡¨å•æäº¤
            document.getElementById('editConfigForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveEditConfig(config.id);
            });
        }

        // ä¿å­˜ç¼–è¾‘çš„é…ç½®
        async function saveEditConfig(configId) {
            try {
                const formData = {
                    platform: document.getElementById('editPlatform').value,
                    document_id: document.getElementById('editDocumentId').value,
                    sync_direction: document.getElementById('editSyncDirection').value,
                    is_sync_enabled: document.getElementById('editIsEnabled').checked,
                    auto_sync: document.getElementById('editAutoSync').checked
                };

                const response = await fetch(`/api/sync/config/${configId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('success', 'é…ç½®æ›´æ–°æˆåŠŸ');
                    closeEditModal();
                    loadConfigs(); // ç«‹å³åˆ·æ–°é…ç½®åˆ—è¡¨
                    loadDashboardData(); // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                } else {
                    showAlert('error', data.message || 'æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                showAlert('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // åˆ é™¤é…ç½®
        async function deleteConfig(configId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`/api/sync/config/${configId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('success', 'é…ç½®å·²åˆ é™¤');
                    loadConfigs();
                    loadDashboardData();
                } else {
                    const result = await response.json();
                    showAlert('error', result.error || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤é…ç½®å¤±è´¥:', error);
                showAlert('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // åŠ è½½åŒæ­¥å†å²
        async function loadHistory() {
            try {
                const response = await fetch('/api/sync/history');
                const data = await response.json();
                
                displayHistory(data.data.history || []);
            } catch (error) {
                console.error('åŠ è½½å†å²å¤±è´¥:', error);
                showAlert('error', 'æ— æ³•åŠ è½½åŒæ­¥å†å²');
            }
        }

        // æ˜¾ç¤ºåŒæ­¥å†å²
        function displayHistory(history) {
            const container = document.getElementById('historyContainer');
            const isBatchMode = document.getElementById('enableBatchDelete')?.checked || false;
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— åŒæ­¥è®°å½•</h3>
                        <p>å½“æœ‰åŒæ­¥æ“ä½œæ—¶ï¼Œè®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                ${isBatchMode ? `
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label>
                                <input type="checkbox" id="selectAllRecords" onchange="toggleSelectAll()"> å…¨é€‰
                            </label>
                            <button class="btn btn-danger" onclick="deleteBatchRecords()" style="font-size: 14px;">
                                ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­è®°å½•
                            </button>
                        </div>
                    </div>
                ` : ''}
                <table class="table">
                    <thead>
                        <tr>
                            ${isBatchMode ? '<th width="50px">é€‰æ‹©</th>' : ''}
                            <th>ç¼–å·</th>
                            <th>æ—¶é—´</th>
                            <th>æ¥æº</th>
                            <th>ç›®æ ‡</th>
                            <th>æ–‡æ¡£ID</th>
                            <th>ç±»å‹</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${history.map(record => `
                            <tr>
                                ${isBatchMode ? `<td><input type="checkbox" class="record-checkbox" value="${record.id}"></td>` : ''}
                                <td>
                                    <span style="font-family: monospace; font-size: 12px; background: #e2e8f0; padding: 2px 6px; border-radius: 4px;">
                                        ${record.record_number || `SYNC-${String(record.id).padStart(6, '0')}`}
                                    </span>
                                </td>
                                <td>${new Date(record.created_at).toLocaleString()}</td>
                                <td>${record.source_platform === 'feishu' ? 'ğŸ“± é£ä¹¦' : 'ğŸ“‹ Notion'}</td>
                                <td>${record.target_platform === 'feishu' ? 'ğŸ“± é£ä¹¦' : 'ğŸ“‹ Notion'}</td>
                                <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${record.source_id}">${record.source_id}</td>
                                <td>${record.content_type}</td>
                                <td>
                                    <span class="status-badge ${getStatusClass(record.sync_status)}">
                                        ${getStatusText(record.sync_status)}
                                    </span>
                                </td>
                                <td style="white-space: nowrap;">
                                    <button class="btn btn-secondary" onclick="retrySync(${record.id})" 
                                            style="font-size: 12px; padding: 5px 10px; margin-right: 5px;">
                                        ğŸ”„ é‡è¯•
                                    </button>
                                    <button class="btn btn-danger" onclick="deleteRecord(${record.id})" 
                                            style="font-size: 12px; padding: 5px 10px;">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            const classes = {
                'success': 'status-success',
                'failed': 'status-error',
                'pending': 'status-warning',
                'processing': 'status-info'
            };
            return classes[status] || 'status-warning';
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const texts = {
                'success': 'æˆåŠŸ',
                'failed': 'å¤±è´¥',
                'pending': 'ç­‰å¾…ä¸­',
                'processing': 'å¤„ç†ä¸­'
            };
            return texts[status] || status;
        }

        // åŠ è½½å›¾ç‰‡ç»Ÿè®¡
        async function loadImageStats() {
            const imageStats = dashboardData.image_stats || {};
            
            document.getElementById('totalImages').textContent = imageStats.total_images || 0;
            document.getElementById('storageUsage').textContent = (imageStats.size_mb || 0) + ' MB';
            document.getElementById('totalAccess').textContent = imageStats.total_access || 0;
            document.getElementById('avgSize').textContent = Math.round((imageStats.avg_size || 0) / 1024) + ' KB';
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showAlert(type, message) {
            // åˆ›å»ºä¸´æ—¶é€šçŸ¥å…ƒç´ 
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.minWidth = '300px';
            alert.innerHTML = `
                <strong>${type === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ é”™è¯¯'}</strong><br>
                ${message}
            `;
            
            document.body.appendChild(alert);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                document.body.removeChild(alert);
            }, 3000);
        }

        // åˆ·æ–°å†å²
        function refreshHistory() {
            loadHistory();
            showAlert('success', 'å†å²è®°å½•å·²åˆ·æ–°');
        }

        // æ˜¾ç¤ºå¾…å¤„ç†ä»»åŠ¡
        async function showPendingTasks() {
            try {
                const response = await fetch('/api/sync/pending');
                const data = await response.json();
                displayHistory(data.data.records || []);
            } catch (error) {
                showAlert('error', 'æ— æ³•åŠ è½½å¾…å¤„ç†ä»»åŠ¡');
            }
        }

        // æ˜¾ç¤ºå¤±è´¥ä»»åŠ¡
        async function showFailedTasks() {
            try {
                const response = await fetch('/api/sync/failed');
                const data = await response.json();
                displayHistory(data.data.records || []);
            } catch (error) {
                showAlert('error', 'æ— æ³•åŠ è½½å¤±è´¥ä»»åŠ¡');
            }
        }

        // æµ‹è¯•åŒæ­¥
        async function testSync(platform, documentId) {
            try {
                showAlert('info', `å¼€å§‹æµ‹è¯• ${platform} æ–‡æ¡£ ${documentId} çš„åŒæ­¥åŠŸèƒ½...`);
                
                // ç¡®å®šç›®æ ‡å¹³å°
                const targetPlatform = platform === 'feishu' ? 'notion' : 'feishu';
                
                const formData = {
                    source_platform: platform,
                    target_platform: targetPlatform,
                    source_id: documentId,
                    content_type: 'document'
                };
                
                const response = await fetch('/api/sync/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', `æµ‹è¯•åŒæ­¥æˆåŠŸï¼åŒæ­¥è®°å½•ID: ${result.sync_record_id}`);
                    loadDashboardData();
                    
                    // åˆ‡æ¢åˆ°å†å²æ ‡ç­¾é¡µæ˜¾ç¤ºç»“æœ
                    setTimeout(() => {
                        showTab('history');
                        loadHistory();
                    }, 1000);
                } else {
                    showAlert('error', `æµ‹è¯•åŒæ­¥å¤±è´¥: ${result.error}`);
                }
            } catch (error) {
                console.error('æµ‹è¯•åŒæ­¥å¤±è´¥:', error);
                showAlert('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }


        // é‡è¯•åŒæ­¥
        async function retrySync(recordId) {
            if (!confirm('ç¡®å®šè¦é‡è¯•è¿™ä¸ªåŒæ­¥ä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }
            
            try {
                showAlert('info', `æ­£åœ¨é‡è¯•åŒæ­¥ä»»åŠ¡ ${recordId}...`);
                
                const response = await fetch(`/api/sync/retry/${recordId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    if (result.result && result.result.success) {
                        showAlert('success', `åŒæ­¥ä»»åŠ¡ ${recordId} é‡è¯•æˆåŠŸï¼`);
                    } else {
                        showAlert('warning', `åŒæ­¥ä»»åŠ¡ ${recordId} é‡è¯•å®Œæˆï¼Œä½†å¯èƒ½æœ‰é—®é¢˜`);
                    }
                    
                    // åˆ·æ–°å†å²è®°å½•å’Œç»Ÿè®¡
                    setTimeout(() => {
                        loadHistory();
                        loadDashboardData();
                    }, 1000);
                } else {
                    showAlert('error', `é‡è¯•å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
            } catch (error) {
                console.error('é‡è¯•åŒæ­¥å¤±è´¥:', error);
                showAlert('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // æ˜¾ç¤ºåˆ é™¤èœå•
        function showDeleteMenu() {
            document.getElementById('deleteMenu').classList.remove('hidden');
        }

        // éšè—åˆ é™¤èœå•
        function hideDeleteMenu() {
            document.getElementById('deleteMenu').classList.add('hidden');
            // é‡ç½®æ‰¹é‡åˆ é™¤æ¨¡å¼
            const batchCheckbox = document.getElementById('enableBatchDelete');
            if (batchCheckbox && batchCheckbox.checked) {
                batchCheckbox.checked = false;
                toggleBatchSelect();
            }
        }

        // åˆ‡æ¢æ‰¹é‡é€‰æ‹©æ¨¡å¼
        function toggleBatchSelect() {
            loadHistory(); // é‡æ–°åŠ è½½å†å²è®°å½•ä»¥åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllRecords');
            const checkboxes = document.querySelectorAll('.record-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        // åˆ é™¤å•æ¡è®°å½•
        async function deleteRecord(recordId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡åŒæ­¥è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`/api/sync/record/${recordId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', 'è®°å½•åˆ é™¤æˆåŠŸ');
                    loadHistory();
                    loadDashboardData();
                } else {
                    showAlert('error', result.message || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤è®°å½•å¤±è´¥:', error);
                showAlert('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // æ‰¹é‡åˆ é™¤é€‰ä¸­è®°å½•
        async function deleteBatchRecords() {
            const checkboxes = document.querySelectorAll('.record-checkbox:checked');
            const recordIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (recordIds.length === 0) {
                showAlert('warning', 'è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${recordIds.length} æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }

            try {
                const response = await fetch('/api/sync/records/batch', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        record_ids: recordIds
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', result.message);
                    loadHistory();
                    loadDashboardData();
                } else {
                    showAlert('error', result.message || 'æ‰¹é‡åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
                showAlert('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // æ¸…ç©ºè®°å½•ï¼ˆæŒ‰çŠ¶æ€ï¼‰
        async function clearRecords(status) {
            let confirmMessage = '';
            switch (status) {
                case 'success':
                    confirmMessage = 'ç¡®å®šè¦åˆ é™¤æ‰€æœ‰æˆåŠŸçš„åŒæ­¥è®°å½•å—ï¼Ÿ';
                    break;
                case 'failed':
                    confirmMessage = 'ç¡®å®šè¦åˆ é™¤æ‰€æœ‰å¤±è´¥çš„åŒæ­¥è®°å½•å—ï¼Ÿ';
                    break;
                case 'pending':
                    confirmMessage = 'ç¡®å®šè¦åˆ é™¤æ‰€æœ‰å¾…å¤„ç†çš„åŒæ­¥è®°å½•å—ï¼Ÿ';
                    break;
                case 'all':
                    confirmMessage = 'ç¡®å®šè¦åˆ é™¤æ‰€æœ‰åŒæ­¥è®°å½•å—ï¼Ÿè¿™å°†æ¸…ç©ºæ•´ä¸ªåŒæ­¥å†å²ï¼';
                    break;
                default:
                    showAlert('error', 'æ— æ•ˆçš„çŠ¶æ€å‚æ•°');
                    return;
            }

            if (!confirm(confirmMessage + ' æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`/api/sync/records/clear?status=${status}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', result.message);
                    hideDeleteMenu(); // éšè—åˆ é™¤èœå•
                    loadHistory();
                    loadDashboardData();
                } else {
                    showAlert('error', result.message || 'æ¸…ç©ºè®°å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('æ¸…ç©ºè®°å½•å¤±è´¥:', error);
                showAlert('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // å›¾ç‰‡ç®¡ç†ç›¸å…³å‡½æ•°
        async function loadImageStats() {
            try {
                const response = await fetch('/api/images/stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.data.summary;
                    document.getElementById('totalImages').textContent = stats.total_images || 0;
                    document.getElementById('storageUsage').textContent = (stats.total_size_mb || 0) + ' MB';
                    document.getElementById('totalAccess').textContent = stats.total_access_count || 0;
                    document.getElementById('avgSize').textContent = (stats.average_size_kb || 0) + ' KB';
                    
                    // æ›´æ–°å›¾ç‰‡åˆ—è¡¨
                    displayImageManagement(data.data);
                } else {
                    console.error('è·å–å›¾ç‰‡ç»Ÿè®¡å¤±è´¥:', data.message);
                }
            } catch (error) {
                console.error('å›¾ç‰‡ç»Ÿè®¡åŠ è½½å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡ç®¡ç†ç•Œé¢
        function displayImageManagement(data) {
            const container = document.getElementById('imagesContainer');
            
            if (!data || data.summary.total_images === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— å›¾ç‰‡æ•°æ®</h3>
                        <p>å½“æœ‰å›¾ç‰‡ä¸Šä¼ æ—¶ï¼Œç›¸å…³ç»Ÿè®¡ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                `;
                return;
            }
            
            let storageInfo = '';
            if (data.storage_distribution) {
                storageInfo = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div class="stat-card">
                            <h3>æœ¬åœ°å­˜å‚¨</h3>
                            <div class="value">${data.storage_distribution.local_count || 0}</div>
                            <div class="label">å¼ å›¾ç‰‡</div>
                        </div>
                        <div class="stat-card">
                            <h3>äº‘ç«¯å­˜å‚¨</h3>
                            <div class="value">${data.storage_distribution.qiniu_count || 0}</div>
                            <div class="label">å¼ å›¾ç‰‡</div>
                        </div>
                    </div>
                `;
            }
            
            let recentImages = '';
            if (data.recent_images && data.recent_images.length > 0) {
                recentImages = `
                    <h3 style="margin: 30px 0 20px 0; color: #4a5568;">ğŸ“¸ æœ€è¿‘ä¸Šä¼ çš„å›¾ç‰‡</h3>
                    <div style="background: #f7fafc; border-radius: 8px; overflow: hidden;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ–‡ä»¶å“ˆå¸Œ</th>
                                    <th>å¤§å°</th>
                                    <th>ç±»å‹</th>
                                    <th>å­˜å‚¨ä½ç½®</th>
                                    <th>è®¿é—®æ¬¡æ•°</th>
                                    <th>ä¸Šä¼ æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.recent_images.map(img => `
                                    <tr>
                                        <td>
                                            <span style="font-family: monospace; font-size: 12px; background: #e2e8f0; padding: 2px 6px; border-radius: 4px;">
                                                ${img.file_hash.substring(0, 8)}...
                                            </span>
                                        </td>
                                        <td>${Math.round(img.file_size / 1024)} KB</td>
                                        <td>
                                            <span class="status-badge status-info">${img.file_type}</span>
                                        </td>
                                        <td>
                                            <span class="status-badge ${img.storage_type === 'local' ? 'status-warning' : 'status-success'}">
                                                ${img.storage_type === 'local' ? 'æœ¬åœ°' : 'äº‘ç«¯'}
                                            </span>
                                        </td>
                                        <td>${img.access_count}</td>
                                        <td>${new Date(img.upload_time).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            container.innerHTML = `
                ${storageInfo}
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin: 20px 0;">
                    <h4 style="color: #856404; margin-bottom: 10px;">ğŸ’¡ å›¾ç‰‡å­˜å‚¨è¯´æ˜</h4>
                    <p style="color: #856404; margin: 0;">
                        <strong>æœ¬åœ°å­˜å‚¨:</strong> ${data.summary.local_storage_mb || 0} MB - 
                        <strong>äº‘ç«¯å­˜å‚¨:</strong> ${data.summary.total_size_mb || 0} MB
                    </p>
                </div>
                ${recentImages}
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="loadFullImageList()">
                        ğŸ“‹ æŸ¥çœ‹å®Œæ•´å›¾ç‰‡åˆ—è¡¨
                    </button>
                </div>
            `;
        }
        
        // åŠ è½½å®Œæ•´å›¾ç‰‡åˆ—è¡¨
        async function loadFullImageList() {
            try {
                const response = await fetch('/api/images?limit=50');
                const data = await response.json();
                
                if (data.success) {
                    showImageListModal(data.data);
                } else {
                    showAlert('error', 'è·å–å›¾ç‰‡åˆ—è¡¨å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡åˆ—è¡¨å¤±è´¥:', error);
                showAlert('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡åˆ—è¡¨æ¨¡æ€æ¡†
        function showImageListModal(data) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
                    <h2 style="margin-bottom: 20px;">ğŸ“¸ å›¾ç‰‡ç®¡ç†åˆ—è¡¨</h2>
                    <div style="max-height: 60vh; overflow-y: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>å“ˆå¸Œå€¼</th>
                                    <th>å¤§å°</th>
                                    <th>å­˜å‚¨</th>
                                    <th>è®¿é—®</th>
                                    <th>ä¸Šä¼ æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.images.map(img => `
                                    <tr>
                                        <td>
                                            <span style="font-family: monospace; font-size: 11px;">
                                                ${img.file_hash.substring(0, 12)}...
                                            </span>
                                        </td>
                                        <td>${img.file_size_kb} KB</td>
                                        <td>
                                            <span class="status-badge ${img.storage_type === 'local' ? 'status-warning' : 'status-success'}">
                                                ${img.storage_type === 'local' ? 'æœ¬åœ°' : 'äº‘ç«¯'}
                                            </span>
                                        </td>
                                        <td>${img.access_count}</td>
                                        <td style="font-size: 12px;">${new Date(img.upload_time).toLocaleDateString()}</td>
                                        <td>
                                            ${img.local_url ? `<a href="${img.local_url}" target="_blank" class="btn btn-sm">æŸ¥çœ‹</a>` : ''}
                                            ${img.qiniu_url ? `<a href="${img.qiniu_url}" target="_blank" class="btn btn-sm">CDN</a>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <p style="color: #718096; font-size: 14px;">
                            å…± ${data.pagination.total} å¼ å›¾ç‰‡ï¼Œå½“å‰æ˜¾ç¤º ${data.images.length} å¼ 
                        </p>
                    </div>
                    <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeImageListModal()">å…³é—­</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ç‚¹å‡»é®ç½©å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeImageListModal();
                }
            });
        }
        
        // å…³é—­å›¾ç‰‡åˆ—è¡¨æ¨¡æ€æ¡†
        function closeImageListModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
            }
        }
    </script>
</body>
</html>