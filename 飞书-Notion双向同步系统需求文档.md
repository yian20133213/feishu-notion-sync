# 飞书-Notion双向同步系统需求文档

## 1. 项目概述

### 1.1 项目背景
用户需要在飞书上维护面向国内用户的中文文档和知识库，同时在Notion上维护用于NotionNext博客构建的内容。为了避免重复维护工作，需要实现两个平台之间的自动化双向同步。

### 1.2 项目目标
- 实现飞书与Notion的内容双向自动同步
- 解决跨平台图片加载问题
- 支持NotionNext博客网站构建
- 提供完整的同步管理和监控功能

### 1.3 核心价值
- **效率提升**：消除重复维护工作，一次编辑多平台同步
- **内容统一**：确保不同平台内容的一致性
- **用户体验**：国内用户访问飞书，海外用户访问博客
- **技术整合**：打通飞书、Notion、NotionNext技术栈

## 2. 功能需求

### 2.1 同步范围
- **飞书多维表格** ↔ **Notion数据库**
- **飞书文档** ↔ **Notion页面**
- **飞书云文档** ↔ **Notion工作区**

### 2.2 内容格式规范
- **统一标准**：所有内容统一使用Markdown格式
- **格式转换流程**：
  - 飞书富文本 → Markdown → Notion Block
  - Notion Block → Markdown → 飞书富文本
- **兼容性处理**：确保格式转换过程中不丢失关键信息

### 2.3 同步方式

#### 2.3.1 同步方向控制
**飞书 → Notion（自动同步）**：
- 实时同步：基于飞书Webhook触发
- 定时同步：每小时检查一次更新作为备用机制
- 飞书作为主要内容源，变更自动推送到Notion

**Notion → 飞书（手动确认）**：
- 手动触发：用户主动发起同步请求
- 审核模式：提供Web界面预览变更内容
- 用户确认：需要用户手动确认是否执行同步
- 防误操作：避免意外覆盖飞书重要内容

#### 2.3.2 触发机制
- **实时同步**：Webhook实时响应内容变更
- **定时同步**：Cron定时任务作为补充机制
- **手动同步**：Web管理界面一键触发
- **批量同步**：支持选择多个文档批量处理

### 2.4 选择性同步

#### 2.4.1 文档标记机制
- **标签标识**：飞书文档添加`[同步]`或`#sync`标记
- **文件夹级别**：支持整个文档文件夹的同步控制
- **排除规则**：支持添加排除标记，如`[不同步]`或`#nosync`

#### 2.4.2 同步范围配置
- **可视化配置**：Web管理界面选择同步范围
- **批量设置**：支持批量添加/移除同步标记
- **同步预览**：显示将要同步的文档列表

### 2.5 图片处理方案

#### 2.5.1 存储架构
- **中转存储**：使用七牛云对象存储作为图片中转站
- **统一访问**：两个平台都引用七牛云CDN链接
- **成本控制**：利用七牛云免费额度（10GB存储+10GB流量/月）

#### 2.5.2 图片处理流程
**飞书 → Notion**：
1. 检测飞书文档中的图片链接
2. 下载图片到本地临时目录
3. 压缩优化图片（WebP格式，减少70%大小）
4. 上传图片到七牛云存储
5. 生成CDN访问链接
6. 替换Notion文档中的图片链接

**Notion → 飞书**：
1. 检测Notion页面中的图片链接
2. 下载图片（如果不在七牛云）
3. 上传到七牛云存储
4. 更新飞书文档中的图片链接

#### 2.5.3 图片优化策略
- **格式转换**：自动转换为WebP格式
- **尺寸优化**：根据使用场景调整图片尺寸
- **去重处理**：使用MD5校验，相同图片只存储一份
- **懒加载支持**：为博客网站提供响应式图片

## 3. 技术架构

### 3.1 技术栈选择
- **后端框架**：Python + FastAPI
- **数据库**：MySQL（存储同步状态、配置信息）
- **任务队列**：Celery + Redis（处理异步同步任务）
- **图片存储**：七牛云对象存储 + CDN
- **服务器**：腾讯云服务器（已备案域名）
- **前端界面**：Vue.js + Element UI（管理界面）

### 3.2 系统架构
```
┌─────────────────┐    ┌─────────────────────┐    ┌─────────────────┐
│     飞书平台     │    │    同步服务系统      │    │   Notion平台    │
│                │    │                    │    │                │
│  • 企业文档     │◄──►│  • API集成         │◄──►│  • 个人页面     │
│  • 多维表格     │    │  • 格式转换        │    │  • 数据库       │
│  • 云文档       │    │  • 图片处理        │    │  • 工作区       │
│                │    │  • 冲突解决        │    │                │
└─────────────────┘    │  • 状态监控        │    └─────────────────┘
                      └─────────────────────┘
                               │
                      ┌─────────────────────┐
                      │    七牛云存储        │
                      │                    │
                      │  • 图片存储        │
                      │  • CDN加速         │
                      │  • 访问优化        │
                      └─────────────────────┘
```

### 3.3 数据库设计

#### 3.3.1 同步记录表 (sync_records)
```sql
CREATE TABLE sync_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    source_platform VARCHAR(20) NOT NULL,  -- 'feishu' or 'notion'
    target_platform VARCHAR(20) NOT NULL,
    source_id VARCHAR(100) NOT NULL,       -- 源文档ID
    target_id VARCHAR(100),                -- 目标文档ID
    content_type VARCHAR(20) NOT NULL,     -- 'document', 'database', 'page'
    sync_status VARCHAR(20) NOT NULL,      -- 'pending', 'processing', 'success', 'failed'
    last_sync_time TIMESTAMP,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 3.3.2 图片映射表 (image_mappings)
```sql
CREATE TABLE image_mappings (
    id INT PRIMARY KEY AUTO_INCREMENT,
    original_url VARCHAR(500) NOT NULL,
    qiniu_url VARCHAR(500) NOT NULL,
    file_hash VARCHAR(64) NOT NULL,        -- MD5校验和
    file_size INT NOT NULL,
    upload_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    access_count INT DEFAULT 0,
    INDEX idx_original_url (original_url),
    INDEX idx_file_hash (file_hash)
);
```

#### 3.3.3 同步配置表 (sync_configs)
```sql
CREATE TABLE sync_configs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    platform VARCHAR(20) NOT NULL,
    document_id VARCHAR(100) NOT NULL,
    is_sync_enabled BOOLEAN DEFAULT TRUE,
    sync_direction VARCHAR(20) NOT NULL,   -- 'feishu_to_notion', 'notion_to_feishu', 'bidirectional'
    auto_sync BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## 4. 接口设计

### 4.1 飞书API集成
- **文档API**：获取、创建、更新文档内容
- **多维表格API**：读取、写入表格数据
- **Webhook接收**：实时接收内容变更通知
- **图片API**：下载飞书中的图片资源

### 4.2 Notion API集成
- **页面API**：获取、创建、更新页面内容
- **数据库API**：读取、写入数据库记录
- **Block API**：处理页面内容块
- **文件上传API**：上传图片等文件资源

### 4.3 七牛云API集成
- **对象存储API**：上传、下载、删除文件
- **CDN API**：获取优化后的访问链接
- **图片处理API**：自动压缩、格式转换

### 4.4 内部REST API
```
POST /api/sync/trigger          # 手动触发同步
GET  /api/sync/status/{id}      # 查询同步状态
GET  /api/sync/history          # 同步历史记录
POST /api/sync/config           # 更新同步配置
GET  /api/sync/preview          # 预览待同步内容
POST /api/sync/confirm          # 确认执行同步
```

## 5. 用户界面需求

### 5.1 管理仪表板
- **同步状态概览**：显示总体同步情况
- **实时监控**：当前正在进行的同步任务
- **统计数据**：成功/失败同步次数、处理文档数量
- **系统状态**：API调用频率、存储使用情况

### 5.2 同步管理界面
- **文档列表**：显示所有可同步的文档
- **同步配置**：为每个文档设置同步规则
- **批量操作**：支持批量启用/禁用同步
- **手动触发**：一键同步选定文档

### 5.3 审核确认界面（Notion → 飞书）
- **变更预览**：对比显示变更前后的内容差异
- **批量审核**：支持批量确认多个变更
- **版本对比**：显示详细的内容变更历史
- **风险提示**：高亮显示可能的风险变更

### 5.4 日志查看界面
- **实时日志**：显示同步过程的详细日志
- **错误诊断**：突出显示错误信息和解决建议
- **日志筛选**：支持按时间、状态、文档等条件筛选
- **日志导出**：支持导出日志用于问题分析

## 6. 数据安全与备份

### 6.1 备份策略
- **同步前备份**：每次同步前自动备份原内容
- **增量备份**：只备份变更部分，节省存储空间
- **定期备份**：每日定时备份关键配置和状态数据
- **备份验证**：定期验证备份文件的完整性

### 6.2 版本控制
- **变更历史**：记录每次同步的详细变更内容
- **版本对比**：支持任意两个版本之间的对比
- **回滚功能**：支持一键回滚到指定历史版本
- **分支管理**：支持创建分支进行试验性同步

### 6.3 数据校验
- **内容完整性**：同步后验证内容是否完整
- **格式正确性**：检查Markdown格式是否正确
- **链接有效性**：验证图片和超链接是否可访问
- **数据一致性**：确保两平台数据保持一致

## 7. 性能优化

### 7.1 同步优化
- **增量同步**：基于时间戳只同步变更内容
- **并发控制**：限制同时处理的同步任务数量
- **队列机制**：使用消息队列处理大批量同步请求
- **缓存策略**：缓存频繁访问的文档和配置信息

### 7.2 图片优化
- **压缩算法**：使用先进的图片压缩算法
- **格式选择**：优先使用WebP等现代图片格式
- **尺寸适配**：根据使用场景生成不同尺寸版本
- **CDN加速**：利用七牛云CDN提升访问速度

### 7.3 API优化
- **请求合并**：将多个小请求合并为批量请求
- **频率控制**：遵守各平台API调用频率限制
- **重试机制**：网络异常时自动重试，指数退避
- **连接池**：复用HTTP连接，减少连接开销

## 8. 监控告警

### 8.1 系统监控
- **同步状态监控**：实时监控同步任务执行状态
- **API调用监控**：监控各平台API调用成功率和延迟
- **存储使用监控**：监控七牛云存储和流量使用情况
- **服务器资源监控**：CPU、内存、磁盘使用率

### 8.2 告警机制
- **同步失败告警**：同步失败时立即发送邮件/飞书通知
- **系统异常告警**：服务器异常时发送告警消息
- **资源预警**：存储或流量接近限额时提前告警
- **API限制告警**：接近API调用限制时发送警告

### 8.3 日志系统
- **分级日志**：INFO/WARN/ERROR/DEBUG日志分类
- **结构化日志**：使用JSON格式便于分析
- **日志轮转**：按大小和时间自动轮转日志文件
- **集中管理**：统一收集和管理所有模块日志

## 9. 扩展性考虑

### 9.1 架构扩展
- **插件机制**：支持自定义内容处理规则和转换逻辑
- **多平台支持**：为接入其他平台（如语雀、石墨等）预留接口
- **微服务架构**：支持拆分为独立的微服务模块
- **容器化部署**：支持Docker容器化部署

### 9.2 功能扩展
- **智能推荐**：基于历史数据推荐同步策略
- **批量迁移**：支持历史数据的批量迁移功能
- **协作功能**：支持多用户协作和权限管理
- **分析报告**：提供详细的使用分析和统计报告

### 9.3 API开放
- **REST API**：提供完整的REST API接口
- **SDK支持**：提供多语言SDK便于第三方集成
- **Webhook支持**：支持向第三方系统推送事件通知
- **开发者文档**：提供详细的API文档和示例代码

## 10. 部署与运维

### 10.1 部署环境
- **服务器配置**：腾讯云服务器，已配置SSL证书
- **域名解析**：已备案域名，支持HTTPS访问
- **数据库部署**：MySQL数据库，支持主从复制
- **缓存服务**：Redis缓存，提升系统性能

### 10.2 运维管理
- **自动化部署**：使用CI/CD流水线自动部署
- **健康检查**：定期检查各服务模块健康状态
- **性能监控**：实时监控系统性能指标
- **故障恢复**：制定完整的故障恢复预案

### 10.3 安全措施
- **API认证**：使用OAuth 2.0或API Key认证
- **数据加密**：敏感数据加密存储和传输
- **访问控制**：基于角色的访问控制机制
- **安全审计**：记录所有关键操作的审计日志

## 11. 项目里程碑

### 阶段一：基础功能开发（预计4-5周）
- [ ] 飞书和Notion API集成
- [ ] 基础同步功能实现
- [ ] 图片处理模块开发
- [ ] 数据库设计和实现

### 阶段二：高级功能开发（预计3-4周）
- [ ] Web管理界面开发
- [ ] 审核确认流程实现
- [ ] 选择性同步功能
- [ ] 监控告警系统

### 阶段三：优化和测试（预计2-3周）
- [ ] 性能优化和压力测试
- [ ] 安全性测试和加固
- [ ] 用户体验优化
- [ ] 文档和培训材料

### 阶段四：部署和运维（预计1-2周）
- [ ] 生产环境部署
- [ ] 监控系统配置
- [ ] 备份恢复测试
- [ ] 用户培训和交付

## 12. 风险评估与应对

### 12.1 技术风险
- **API变更风险**：飞书/Notion API可能发生变更
  - 应对：定期检查API更新，及时适配新版本
- **性能瓶颈风险**：大量文档同步可能导致性能问题
  - 应对：实施限流、队列、缓存等优化策略

### 12.2 业务风险
- **数据丢失风险**：同步过程可能导致数据丢失
  - 应对：完善的备份机制和版本控制
- **内容冲突风险**：双向同步可能产生内容冲突
  - 应对：完善的冲突检测和解决机制

### 12.3 运维风险
- **服务可用性风险**：服务宕机影响同步功能
  - 应对：高可用架构设计，故障自动恢复
- **成本控制风险**：七牛云使用量超出预期
  - 应对：实时监控使用量，设置预警阈值

## 13. 总结

本需求文档详细描述了飞书-Notion双向同步系统的完整需求，涵盖了功能需求、技术架构、界面设计、安全考虑等各个方面。系统设计遵循以下核心原则：

1. **用户体验优先**：简化操作流程，提供直观的管理界面
2. **数据安全第一**：完善的备份和版本控制机制
3. **性能与成本平衡**：在保证性能的同时控制运营成本
4. **可扩展性设计**：为未来功能扩展和平台接入预留空间

通过实施此系统，将显著提升内容管理效率，实现真正的一次编辑、多平台同步的目标。

---

## 14. 实际部署配置信息

### 14.1 环境配置
**主域名**：yianlu.com（NotionNext博客）  
**同步服务域名**：sync.yianlu.com  
**CDN域名**：cdn.yianlu.com  
**服务器**：腾讯云，已备案，SSL证书已配置  
**部署路径**：/www/wwwroot/sync.yianlu.com/  
**反向代理**：宝塔面板配置，端口5000  

### 14.2 飞书应用配置
**应用类型**：企业自建应用  
**应用名称**：内容同步助手  
**App ID**：cli_a8d295d399a25013  
**App Secret**：FTb3GlyUZlzFF6AK01k0mdtq03SpET7n  
**Webhook URL**：https://sync.yianlu.com/webhook/feishu  

**已配置权限**：
- docs:doc.read - 读取文档
- docs:doc.write - 编辑文档
- bitable:app.read - 读取多维表格
- bitable:app.write - 编辑多维表格
- drive:drive.readonly - 读取云文档

**已订阅事件**：
- drive.file.edit_v1 - 文档编辑事件
- drive.file.title_updated_v1 - 文档标题更新
- drive.file.trashed_v1 - 文档删除回收站
- application.bot.menu_v6 - 机器人自定义菜单事件

### 14.3 Notion集成配置
**集成类型**：Internal Integration  
**集成名称**：飞书同步集成  
**Integration Token**：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  
**测试页面ID**：218ed26c0da0804fbc28dc977e2f4ae8  
**测试页面名称**：易安AI笔记  

**已配置权限**：
- Read content - 读取内容
- Update content - 更新内容
- Insert content - 插入内容

### 14.4 七牛云存储配置
**AccessKey**：quisBFRU_RPX6-fO04_UrfMBukZLs1ofUDyBvgoZ  
**SecretKey**：IeiMby-g2i2V4qYfkot4k41B7Ztd8o8N6YHC8NAf  
**存储空间名称**：feishu-notion-sync  
**空间权限**：私有（推荐，安全性更高）  
**CDN域名**：https://cdn.yianlu.com  
**SSL证书**：已配置，使用宝塔Let's Encrypt证书  

**免费额度**：
- 存储空间：10GB/月
- CDN回源流量：10GB/月
- 上传流量：无限制
- PUT/DELETE请求：10万次/月
- GET请求：100万次/月

### 14.5 流量成本预估
**预计月访问量**：1000UV，每用户3页面，每页面5图片  
**原始流量需求**：90GB/月  
**优化后流量**：
- 图片压缩（WebP格式）：减少70% → 27GB/月
- 懒加载优化：减少50% → 13.5GB/月
- **超出免费额度**：3.5GB/月
- **预计费用**：3.5GB × 0.15元 = 0.53元/月

### 14.6 域名架构规划
```
yianlu.com           → NotionNext博客（主站）
sync.yianlu.com      → 同步服务后台管理
cdn.yianlu.com       → 七牛云CDN图片访问
```

### 14.7 图片处理策略
**选用方案**：七牛云对象存储 + 自定义CDN域名  
**图片格式**：WebP（压缩率70%）  
**去重机制**：MD5哈希校验  
**访问方式**：https://cdn.yianlu.com/images/[filename]  
**SSL证书**：宝塔Let's Encrypt自动续签（私钥不变）  

### 14.8 开发环境准备
**服务器环境**：
- 操作系统：Linux
- Python版本：Python 3.x
- Web服务器：Nginx（宝塔面板管理）
- 反向代理：已配置到Flask 5000端口
- SSL证书：已配置HTTPS

**测试服务状态**：
- Webhook验证服务：已部署并运行
- 健康检查接口：https://sync.yianlu.com/health ✅
- 反向代理：已配置 ✅

---

**文档版本**：v2.0  
**创建日期**：2025年6月22日  
**最后更新**：2025年6月23日  
**文档状态**：配置完成，准备开发